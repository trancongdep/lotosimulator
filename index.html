<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng ƒê√†o T·∫°o LOTO (Ver 1.2)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-dark: #1e272e;
            --sidebar-width: 280px;
            --danger: #ff4757;
            --success: #2ed573;
            --warning: #ffa502;
            --metal: #747d8c;
            --blue: #3742fa;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: white;
            overflow: hidden;
        }

        /* --- SCREEN MANAGEMENT --- */
        .screen {
            display: none; width: 100vw; height: 100vh;
            position: absolute; top: 0; left: 0;
        }
        .screen.active { display: flex; }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            background: radial-gradient(circle, #2f3542 0%, #1e272e 100%);
            align-items: center; justify-content: center; flex-direction: column;
        }
        .login-btn {
            background: white; color: #333; padding: 15px 30px; border: none;
            border-radius: 50px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.2s;
        }
        .login-btn:hover { transform: scale(1.05); }

        /* --- INSTRUCTOR SCREEN --- */
        #instructor-screen { flex-direction: column; padding: 20px; box-sizing: border-box;}
        .inst-controls { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; height: 100%; }
        .inst-panel { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; overflow-y: auto; }
        
        #role-switcher {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            background: var(--warning); color: black; padding: 8px 15px;
            border-radius: 20px; cursor: pointer; font-weight: bold; display: none;
            border: 2px solid white;
        }

        /* --- STUDENT SCREEN --- */
        #student-screen {
            display: flex; flex-direction: row; overflow: hidden;
        }

        /* SIDEBAR (TOOLBOX) */
        .sidebar {
            width: 60px; /* Collapsed width */
            background: #2f3542;
            border-right: 2px solid #57606f;
            transition: width 0.3s;
            display: flex; flex-direction: column; align-items: center;
            padding-top: 20px; z-index: 100;
            overflow: hidden;
        }
        .sidebar:hover { width: var(--sidebar-width); }
        .sidebar-title { 
            white-space: nowrap; font-weight: bold; margin-bottom: 20px; 
            color: var(--warning); opacity: 0; transition: 0.2s;
        }
        .sidebar:hover .sidebar-title { opacity: 1; }

        .tool-item {
            display: flex; align-items: center; width: 90%; padding: 10px;
            margin-bottom: 10px; cursor: grab; border-radius: 5px;
            transition: background 0.2s; color: #dfe4ea;
        }
        .tool-item:hover { background: rgba(255,255,255,0.1); }
        .tool-icon { font-size: 24px; min-width: 40px; text-align: center; }
        .tool-label { white-space: nowrap; margin-left: 10px; opacity: 0; transition: 0.1s;}
        .sidebar:hover .tool-label { opacity: 1; }

        /* MAIN WORKSPACE */
        .workspace {
            flex-grow: 1; position: relative;
            background: url('https://www.transparenttextures.com/patterns/dark-matter.png'), linear-gradient(to bottom, #535c68, #2c3e50);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* ELECTRICAL PANEL (3 CBs) */
        .panel-box {
            background: #dcdde1; border: 4px solid #7f8c8d; border-radius: 10px;
            padding: 20px; display: flex; gap: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }
        .panel-label {
            position: absolute; top: -15px; left: 20px; background: #c23616; color: white;
            padding: 5px 15px; font-weight: bold; border-radius: 4px; font-size: 0.9rem;
        }

        .cb-unit {
            width: 80px; height: 160px; background: #353b48; border-radius: 4px;
            position: relative; border: 2px solid #2f3640;
            display: flex; flex-direction: column; align-items: center;
        }
        .cb-name { color: white; font-size: 0.7rem; margin-top: 5px; text-align: center;}
        
        .cb-handle {
            width: 60px; height: 50px; background: var(--danger);
            border-radius: 4px; margin-top: 20px; cursor: pointer;
            transition: transform 0.3s, background 0.3s;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 0.8rem; z-index: 5;
            position: relative; top: 0;
        }
        .cb-handle.off { transform: translateY(50px); background: var(--success); }
        
        .cb-hole {
            width: 20px; height: 20px; background: black; border-radius: 50%;
            border: 2px solid silver; margin-top: 35px; z-index: 1;
        }

        /* Items dropped on CB */
        .deployed-lock { position: absolute; top: 80px; left: 15px; width: 50px; z-index: 10; pointer-events: none;}
        .deployed-tag { position: absolute; top: 110px; left: 30px; width: 40px; transform: rotate(-10deg); z-index: 11; pointer-events: none;}

        /* MACHINE VISUAL */
        .machine-viz {
            margin-bottom: 50px; text-align: center;
        }
        .fan {
            width: 120px; height: 120px; border: 5px solid #bdc3c7; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto;
            background: #2f3542;
        }
        .blade { width: 110px; height: 15px; background: silver; position: absolute; border-radius: 50%; }
        .blade:nth-child(1) { transform: rotate(0deg); }
        .blade:nth-child(2) { transform: rotate(120deg); }
        .blade:nth-child(3) { transform: rotate(240deg); }
        
        .spinning { animation: spin 0.2s linear infinite; }
        .coasting { animation: spin 3s ease-out forwards; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* DECISION BAR */
        .decision-bar {
            position: absolute; bottom: 0; width: 100%;
            background: rgba(0,0,0,0.8); padding: 15px;
            display: flex; justify-content: center; gap: 20px;
            transform: translateY(100%); transition: 0.3s;
        }
        .decision-bar.active { transform: translateY(0); }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; display: none;
            align-items: center; justify-content: center;
        }
        .modal-content { background: white; padding: 20px; border-radius: 8px; color: #333; max-width: 600px; text-align: center;}
        
        .diagram-img { width: 100%; height: auto; border: 2px solid #333; margin: 10px 0; }

        /* NOTIFICATION POPUP */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--blue); color: white; padding: 10px 20px; border-radius: 30px;
            z-index: 3000; opacity: 0; transition: 0.5s; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="role-switcher" onclick="switchView()">üîÑ Chuy·ªÉn M√†n H√¨nh</div>

    <div id="toast" class="toast">Th√¥ng b√°o...</div>

    <div id="login-screen" class="screen active">
        <h1 style="color:white; text-transform: uppercase; letter-spacing: 2px;">M√¥ Ph·ªèng An To√†n LOTO v1.2</h1>
        <button class="login-btn" onclick="handleLogin()">
            <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.2,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.1,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.25,22C17.6,22 21.5,18.33 21.5,12.91C21.5,11.76 21.35,11.1 21.35,11.1V11.1Z"/></svg>
            ƒêƒÉng nh·∫≠p v·ªõi Google
        </button>
        <p style="margin-top:20px; font-size: 0.8rem; opacity: 0.7;">Gi·∫£ng vi√™n: deptc.gvatvsld@gmail.com</p>
    </div>

    <div id="instructor-screen" class="screen">
        <h2 style="border-bottom: 2px solid var(--warning); padding-bottom: 10px;">B·∫¢NG ƒêI·ªÄU KHI·ªÇN GI·∫¢NG VI√äN</h2>
        <div class="inst-controls">
            <div class="inst-panel">
                <h3>Tr·∫°ng th√°i b√†i t·∫≠p</h3>
                <p>H·ªçc vi√™n: <span id="inst-student-name">...</span></p>
                <p>Ngu·ªìn ƒëi·ªán CB-2 (Motor): <span id="inst-cb2-status" style="color:red">ON</span></p>
                <p>Kh√≥a LOTO: <span id="inst-lock-status">Ch∆∞a kh√≥a</span></p>
                <hr>
                <button onclick="triggerDecision()" style="width:100%; padding: 10px; background: var(--blue); color: white; border: none; cursor: pointer; border-radius: 4px;">üîî Y√™u c·∫ßu H·ªçc vi√™n ƒê√°nh gi√°</button>
                <br><br>
                <button onclick="resetSim()" style="width:100%; padding: 10px; background: var(--danger); color: white; border: none; cursor: pointer; border-radius: 4px;">‚ö†Ô∏è Reset B√†i T·∫≠p</button>
            </div>
            <div class="inst-panel" id="inst-logs">
                <div style="font-family: monospace; color: #2ed573;">> H·ªá th·ªëng s·∫µn s√†ng...</div>
            </div>
        </div>
    </div>

    <div id="student-screen" class="screen">
        
        <div class="sidebar">
            <div class="sidebar-title">H·ªòP D·ª§NG C·ª§</div>
            
            <div class="tool-item" onclick="useSpeaker()">
                <div class="tool-icon">üì¢</div>
                <div class="tool-label">Loa th√¥ng b√°o</div>
            </div>

            <div class="tool-item" onclick="showDiagram()">
                <div class="tool-icon">üó∫Ô∏è</div>
                <div class="tool-label">S∆° ƒë·ªì c·∫•p ƒëi·ªán</div>
            </div>

            <hr style="width: 80%; border-color: #57606f;">

            <div class="tool-item" draggable="true" ondragstart="drag(event)" id="tool-lock">
                <div class="tool-icon">üîí</div>
                <div class="tool-label">·ªî kh√≥a an to√†n</div>
            </div>

            <div class="tool-item" draggable="true" ondragstart="drag(event)" id="tool-tag">
                <div class="tool-icon">üè∑Ô∏è</div>
                <div class="tool-label">Th·∫ª c·∫£nh b√°o</div>
            </div>

            <div class="tool-item" draggable="true" ondragstart="drag(event)" id="tool-meter">
                <div class="tool-icon">‚ö°</div>
                <div class="tool-label">ƒê·ªìng h·ªì VOM</div>
            </div>

            <div class="tool-item" draggable="true" ondragstart="drag(event)" id="tool-pen">
                <div class="tool-icon">üñçÔ∏è</div>
                <div class="tool-label">B√∫t th·ª≠ ƒëi·ªán</div>
            </div>
        </div>

        <div class="workspace">
            <div style="position: absolute; top: 10px; right: 20px; text-align: right;">
                <small id="user-display">H·ªçc vi√™n</small>
                <br>
                <button onclick="toggleDecisionBar()" style="margin-top: 5px; background: #333; color: white; border: 1px solid white; cursor: pointer;">M·ªü Menu Quy·∫øt ƒê·ªãnh</button>
            </div>

            <div class="machine-viz">
                <h3 style="margin-bottom: 5px;">QU·∫†T H√öT S·ªê 2</h3>
                <div class="fan">
                    <div class="blade spinning" id="blade1"></div>
                    <div class="blade spinning" id="blade2"></div>
                    <div class="blade spinning" id="blade3"></div>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="operateMachine(true)" style="background:var(--success); border:none; padding:5px 15px; cursor:pointer;">START</button>
                    <button onclick="operateMachine(false)" style="background:var(--danger); border:none; padding:5px 15px; cursor:pointer; color:white;">STOP</button>
                </div>
            </div>

            <div class="panel-box">
                <div class="panel-label">T·ª¶ ƒêI·ªÜN PH√ÇN PH·ªêI DB-01</div>
                
                <div class="cb-unit" id="cb1" ondragover="allowDrop(event)" ondrop="drop(event, 1)">
                    <div class="cb-name">CB-01 (ƒê√®n)</div>
                    <div class="cb-handle" onclick="toggleCB(1)">ON</div>
                    <div class="cb-hole"></div>
                    <div id="lock-zone-1"></div>
                </div>

                <div class="cb-unit" id="cb2" ondragover="allowDrop(event)" ondrop="drop(event, 2)">
                    <div class="cb-name">CB-02 (Qu·∫°t)</div>
                    <div class="cb-handle" onclick="toggleCB(2)">ON</div>
                    <div class="cb-hole"></div>
                    <div id="lock-zone-2"></div>
                </div>

                <div class="cb-unit" id="cb3" ondragover="allowDrop(event)" ondrop="drop(event, 3)">
                    <div class="cb-name">CB-03 (·ªî c·∫Øm)</div>
                    <div class="cb-handle" onclick="toggleCB(3)">ON</div>
                    <div class="cb-hole"></div>
                    <div id="lock-zone-3"></div>
                </div>
            </div>
        </div>

        <div class="decision-bar" id="decision-bar">
            <button onclick="makeDecision('redo')" style="background: var(--warning); border:none; padding: 10px 20px; font-weight: bold; cursor: pointer;">‚è™ L√ÄM L·∫†I (Kh√¥ng an to√†n)</button>
            <button onclick="makeDecision('continue')" style="background: var(--metal); border:none; padding: 10px 20px; color: white; cursor: pointer;">‚ñ∂Ô∏è TI·∫æP T·ª§C THAO T√ÅC</button>
            <button onclick="makeDecision('permit')" style="background: var(--blue); border:none; padding: 10px 20px; color: white; font-weight: bold; cursor: pointer;">üìù CHO PH√âP L√ÄM VI·ªÜC</button>
        </div>
    </div>

    <div id="modal-diagram" class="modal-overlay" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>S∆† ƒê·ªí ƒê∆†N TUY·∫æN DB-01</h3>
            <svg class="diagram-img" viewBox="0 0 400 200" style="background: white;">
                <rect x="10" y="10" width="380" height="180" fill="none" stroke="black"/>
                <line x1="20" y1="100" x2="100" y2="100" stroke="red" stroke-width="4"/>
                <text x="30" y="90" fill="red">NGU·ªíN 380V</text>
                
                <line x1="100" y1="50" x2="100" y2="150" stroke="black" stroke-width="4"/>

                <line x1="100" y1="60" x2="200" y2="60" stroke="black" stroke-width="2"/>
                <rect x="200" y="50" width="40" height="20" fill="white" stroke="black"/>
                <text x="250" y="65" font-size="12">CB-01 (Chi·∫øu s√°ng)</text>

                <line x1="100" y1="100" x2="200" y2="100" stroke="black" stroke-width="2"/>
                <rect x="200" y="90" width="40" height="20" fill="white" stroke="red" stroke-width="2"/>
                <text x="250" y="105" font-size="12" font-weight="bold" fill="red">CB-02 (QU·∫†T S·ªê 2)</text>

                <line x1="100" y1="140" x2="200" y2="140" stroke="black" stroke-width="2"/>
                <rect x="200" y="130" width="40" height="20" fill="white" stroke="black"/>
                <text x="250" y="145" font-size="12">CB-03 (·ªî c·∫Øm)</text>
            </svg>
            <p>X√°c nh·∫≠n: <strong>CB-02</strong> c·∫•p ngu·ªìn cho Qu·∫°t H√∫t s·ªë 2.</p>
            <button onclick="document.getElementById('modal-diagram').style.display='none'" style="padding: 5px 20px;">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        firebase.initializeApp(firebaseConfig);

        // STATE
        let role = 'student'; 
        let cbs = {
            1: { on: true, locked: false, tagged: false },
            2: { on: true, locked: false, tagged: false }, // TARGET
            3: { on: true, locked: false, tagged: false }
        };
        let steps = { notified: false, verified: false };
        let motorRunning = true;

        // AUTH
        function handleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider).then(res => {
                checkRole(res.user);
            }).catch(e => {
                // Fallback for local testing without server
                if(window.location.protocol === 'file:') {
                    let email = prompt("Testing Mode. Enter email:", "deptc.gvatvsld@gmail.com");
                    checkRole({email: email});
                } else alert(e.message);
            });
        }

        function checkRole(user) {
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('user-display').innerText = user.email;
            
            if (user.email === 'deptc.gvatvsld@gmail.com') {
                role = 'instructor';
                document.getElementById('role-switcher').style.display = 'block';
                showScreen('instructor-screen');
            } else {
                role = 'student';
                showScreen('student-screen');
                if(document.getElementById('inst-student-name')) 
                    document.getElementById('inst-student-name').innerText = user.email;
            }
            log(`Logged in as ${role}`);
        }

        // NAVIGATION
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function switchView() {
            if(role !== 'instructor') return;
            const current = document.querySelector('.screen.active').id;
            showScreen(current === 'instructor-screen' ? 'student-screen' : 'instructor-screen');
        }

        // TOOLBOX ACTIONS
        function useSpeaker() {
            steps.notified = true;
            showToast("üì¢ ƒê√£ th√¥ng b√°o: 'ƒê·ªÅ ngh·ªã ng·ª´ng v·∫≠n h√†nh ƒë·ªÉ b·∫£o tr√¨!'");
            log("Student used Speaker to Notify.");
        }

        function showDiagram() {
            document.getElementById('modal-diagram').style.display = 'flex';
            log("Student viewed Wiring Diagram.");
        }

        // MACHINE & CBS
        function operateMachine(on) {
            if(on && cbs[2].on) {
                motorRunning = true;
                updateFans();
            } else {
                motorRunning = false;
                updateFans();
            }
        }

        function updateFans() {
            const blades = document.querySelectorAll('.blade');
            if(motorRunning) {
                blades.forEach(b => { b.classList.remove('coasting'); b.classList.add('spinning'); });
            } else {
                blades.forEach(b => { b.classList.remove('spinning'); b.classList.add('coasting'); });
            }
        }

        function toggleCB(id) {
            if(cbs[id].locked) {
                showToast("‚õî Kh√¥ng th·ªÉ thao t√°c! CB ƒëang b·ªã KH√ìA.");
                return;
            }
            cbs[id].on = !cbs[id].on;
            const handle = document.querySelector(`#cb${id} .cb-handle`);
            
            if(cbs[id].on) {
                handle.classList.remove('off'); handle.innerText = "ON";
            } else {
                handle.classList.add('off'); handle.innerText = "OFF";
            }

            // Logic logic: CB2 controls fan
            if(id === 2 && cbs[id].on) operateMachine(true);
            if(id === 2 && !cbs[id].on) operateMachine(false);

            log(`Student toggled CB-${id} to ${cbs[id].on ? 'ON' : 'OFF'}`);
            updateInstUI();
        }

        // DRAG & DROP
        function drag(ev) { ev.dataTransfer.setData("tool", ev.target.id); }
        function allowDrop(ev) { ev.preventDefault(); }
        
        function drop(ev, cbId) {
            ev.preventDefault();
            const tool = ev.dataTransfer.getData("tool");
            const zone = document.getElementById(`lock-zone-${cbId}`);

            if(tool === 'tool-lock') {
                if(cbs[cbId].on) { showToast("‚ö° NGUY HI·ªÇM! Kh√¥ng th·ªÉ kh√≥a khi CB ƒëang ON."); return; }
                if(cbs[cbId].locked) return;
                cbs[cbId].locked = true;
                zone.innerHTML += `<svg class="deployed-lock" viewBox="0 0 100 120"><rect x="20" y="40" width="60" height="70" rx="5" fill="#ff4757"/><path d="M30,40 V25 A20,20 0 0,1 70,25 V40" fill="none" stroke="silver" stroke-width="8"/></svg>`;
                log(`Locked CB-${cbId}`);
            }
            else if(tool === 'tool-tag') {
                if(!cbs[cbId].locked) { showToast("‚ö†Ô∏è Ph·∫£i kh√≥a tr∆∞·ªõc khi treo th·∫ª!"); return; }
                cbs[cbId].tagged = true;
                zone.innerHTML += `<svg class="deployed-tag" viewBox="0 0 80 120"><path d="M0,20 L80,20 L80,120 L0,120 Z" fill="#f1f2f6"/><rect x="10" y="30" width="60" height="20" fill="red"/><text x="40" y="45" font-size="10" text-anchor="middle" fill="white">DANGER</text></svg>`;
                log(`Tagged CB-${cbId}`);
            }
            else if(tool === 'tool-meter' || tool === 'tool-pen') {
                // Verify
                showToast("‚è≥ ƒêang ki·ªÉm tra ƒëi·ªán √°p...");
                setTimeout(() => {
                    if(cbs[cbId].on) {
                        showToast("‚ö° C·∫¢NH B√ÅO: C√ì ƒêI·ªÜN (380V)!");
                        if(tool==='tool-pen') playBeep();
                    } else {
                        showToast("‚úÖ AN TO√ÄN: 0V");
                        if(cbId === 2) steps.verified = true;
                    }
                }, 1000);
                log(`Verified CB-${cbId} with ${tool}`);
            }
            updateInstUI();
        }

        // DECISION WORKFLOW
        function toggleDecisionBar() {
            document.getElementById('decision-bar').classList.toggle('active');
        }

        function triggerDecision() {
            // Called by Instructor
            showToast("üîî GI·∫¢NG VI√äN Y√äU C·∫¶U: H√£y ki·ªÉm tra v√† ƒë∆∞a ra quy·∫øt ƒë·ªãnh!");
            document.getElementById('decision-bar').classList.add('active');
        }

        function makeDecision(choice) {
            document.getElementById('decision-bar').classList.remove('active');
            if(choice === 'redo') {
                if(confirm("B·∫°n mu·ªën l√†m l·∫°i t·ª´ ƒë·∫ßu?")) resetSim();
            } else if (choice === 'continue') {
                // Just close bar
            } else if (choice === 'permit') {
                evaluateSafety();
            }
        }

        function evaluateSafety() {
            // Check Criticals: Notified? CB2 Off? CB2 Locked? CB2 Tagged? Verified?
            if(!steps.notified) { alert("L·ªñI: B·∫°n ch∆∞a Th√¥ng b√°o (B∆∞·ªõc 1)."); return; }
            if(cbs[2].on) { alert("TAI N·∫†N: CB-02 (Qu·∫°t) v·∫´n ƒëang b·∫≠t!"); return; }
            if(!cbs[2].locked) { alert("NGUY HI·ªÇM: B·∫°n ch∆∞a kh√≥a CB-02."); return; }
            if(!steps.verified) { alert("L·ªñI: B·∫°n ch∆∞a ƒëo ki·ªÉm tra ƒëi·ªán √°p."); return; }
            
            // Correct target check
            if(cbs[1].locked || cbs[3].locked) { 
                alert("C·∫¢NH B√ÅO: B·∫°n ƒë√£ kh√≥a nh·∫ßm CB kh√¥ng li√™n quan (S·ª≠ d·ª•ng s∆° ƒë·ªì ƒë·ªÉ ki·ªÉm tra l·∫°i).");
                return;
            }

            alert("‚úÖ XU·∫§T S·∫ÆC! B·∫°n ƒë√£ c√¥ l·∫≠p nƒÉng l∆∞·ª£ng an to√†n v√† ƒë√∫ng quy tr√¨nh.");
            log("Student PASSED.");
        }

        // UTILS
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            console.log(msg);
            if(role === 'instructor' || document.getElementById('inst-logs')) {
                const logs = document.getElementById('inst-logs');
                logs.innerHTML += `<div>[${time}] ${msg}</div>`;
                logs.scrollTop = logs.scrollHeight;
            }
        }

        function updateInstUI() {
            if(document.getElementById('inst-cb2-status')) {
                const stat = document.getElementById('inst-cb2-status');
                stat.innerText = cbs[2].on ? "ON (Nguy hi·ªÉm)" : "OFF";
                stat.style.color = cbs[2].on ? "red" : "green";

                const lock = document.getElementById('inst-lock-status');
                lock.innerText = cbs[2].locked ? "ƒê√£ kh√≥a" : "Ch∆∞a kh√≥a";
            }
        }

        function resetSim() {
            location.reload();
        }

        function playBeep() {
            // Simple beep context (optional)
            // const ctx = new AudioContext(); ...
        }
    </script>
</body>
</html>
