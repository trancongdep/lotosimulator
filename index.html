<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTO Sim v1.8</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-dark: #2f3640;
            --primary: #00a8ff;
            --danger: #e84118;
            --success: #4cd137;
            --text: #f5f6fa;
            --sidebar-w: 280px;
            --header-h: 60px;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text);
            overflow: hidden;
        }

        /* --- HEADER --- */
        .header {
            height: var(--header-h); background: #1e272e;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 2px solid #444;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        #btn-menu {
            background: #353b48; border: 1px solid #718093; color: white;
            font-size: 1.5rem; cursor: pointer; padding: 5px 15px; border-radius: 4px;
            margin-right: 15px; transition: 0.2s;
        }
        #btn-menu:hover { background: var(--primary); border-color: var(--primary); }

        .app-title { font-weight: bold; font-size: 1.2rem; color: var(--primary); }

        /* --- SIDEBAR (2-LEVEL MENU) --- */
        .sidebar {
            position: fixed; top: var(--header-h); bottom: 0; left: calc(var(--sidebar-w) * -1);
            width: var(--sidebar-w); background: #222; border-right: 1px solid #444;
            transition: left 0.3s ease-in-out; z-index: 3000;
            display: flex; flex-direction: column; overflow-y: auto;
            box-shadow: 5px 0 15px rgba(0,0,0,0.7);
        }
        .sidebar.active { left: 0; }

        /* Level 1: Parent Menu */
        .menu-parent {
            padding: 15px 20px; background: #2f3640; border-bottom: 1px solid #333;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; color: #ecf0f1; transition: 0.2s;
        }
        .menu-parent:hover { background: #353b48; color: var(--primary); }
        .menu-parent::after { content: '‚ñº'; font-size: 0.7rem; transition: transform 0.3s; }
        .menu-parent.expanded::after { transform: rotate(180deg); }

        /* Level 2: Sub Menu Container */
        .submenu {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
            background: #1e272e;
        }
        .submenu.open { max-height: 500px; /* Arbitrary large height */ }

        /* Level 2: Items */
        .menu-child {
            padding: 12px 20px 12px 40px; /* Indent */
            display: flex; align-items: center; gap: 10px;
            cursor: pointer; color: #bdc3c7; border-bottom: 1px solid #2c3e50;
            transition: 0.2s;
        }
        .menu-child:hover { background: rgba(255,255,255,0.05); color: white; padding-left: 45px;}
        .menu-child.active { border-left: 3px solid var(--primary); background: rgba(0,168,255,0.1); color: var(--primary); }
        
        .tool-drag { cursor: grab; }
        .tool-drag:active { cursor: grabbing; }

        /* Special Instructor Menu */
        #menu-instructor { display: none; border-top: 2px solid var(--danger); } /* Hidden by default */

        /* --- BACKDROP --- */
        .backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2500; display: none;
        }
        .backdrop.show { display: block; }

        /* --- CONTENT --- */
        .main-content {
            margin-top: var(--header-h); height: calc(100vh - var(--header-h));
            position: relative; background: radial-gradient(at center, #353b48, #2f3640);
        }
        .screen { display: none; height: 100%; width: 100%; }
        .screen.show { display: block; }

        /* Tabs */
        .tab-view {
            display: none; height: 100%; width: 100%; padding: 20px; box-sizing: border-box;
            flex-direction: column; align-items: center; overflow-y: auto;
        }
        .tab-view.show { display: flex; animation: fadeUp 0.3s; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMPONENTS --- */
        /* Device */
        .fan-box {
            width: 250px; height: 250px; border: 10px solid #95a5a6; border-radius: 50%;
            background: #2c3e50; display: flex; align-items: center; justify-content: center;
            margin: 30px auto; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .blade { width: 220px; height: 30px; background: #bdc3c7; position: absolute; border-radius: 15px; }
        .spin { animation: spin 0.2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Panel */
        .panel-grid { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .cb-box {
            width: 110px; height: 200px; background: #34495e; border: 2px solid #555; border-radius: 8px;
            position: relative; display: flex; flex-direction: column; align-items: center;
        }
        .cb-lever {
            width: 70px; height: 60px; background: var(--danger); margin-top: 50px; cursor: pointer;
            border-radius: 5px; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center;
            transition: 0.3s; z-index: 10;
        }
        .cb-lever.off { transform: translateY(60px); background: var(--success); }
        .drop-zone { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        .vis-lock { position: absolute; top: 35px; left: 30px; font-size: 3rem; z-index: 20; pointer-events: none; filter: drop-shadow(0 4px 4px #000); }
        .vis-tag { position: absolute; top: 65px; left: 35px; font-size: 2.5rem; z-index: 21; pointer-events: none; transform: rotate(-15deg); filter: drop-shadow(0 4px 4px #000); }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 100px);
            background: #333; color: white; padding: 12px 30px; border-radius: 30px; 
            border: 2px solid var(--primary); font-weight: bold;
            transition: 0.3s; z-index: 4000; opacity: 0;
        }
        .toast.show { transform: translate(-50%, 0); opacity: 1; }

    </style>
</head>
<body>

    <div class="header">
        <div style="display: flex; align-items: center;">
            <button id="btn-menu" onclick="toggleSidebar()">‚ò∞</button>
            <div class="app-title">LOTO Sim v1.8</div>
        </div>
        <div id="user-display" style="font-size:0.9rem; color:#ccc;">Guest</div>
    </div>

    <div class="backdrop" id="menu-backdrop" onclick="closeSidebar()"></div>

    <div id="toast" class="toast">H·ªá th·ªëng s·∫µn s√†ng</div>

    <div id="screen-login" class="screen show">
        <div style="height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column;">
            <div style="background:white; padding:40px; border-radius:10px; text-align:center; color:#333;">
                <h1 style="margin-top:0;">ƒêƒÇNG NH·∫¨P</h1>
                <p>H·ªá th·ªëng ƒê√†o t·∫°o An to√†n Lao ƒë·ªông</p>
                <button onclick="doLogin()" style="padding:15px 30px; background:#e74c3c; color:white; border:none; font-weight:bold; cursor:pointer; font-size:1.1rem; border-radius:5px;">
                    ƒêƒÉng nh·∫≠p Google
                </button>
                <div style="margin-top:15px; font-size:0.8rem; color:#666;">
                    Gi·∫£ng vi√™n: deptc.gvatvsld@gmail.com
                </div>
            </div>
        </div>
    </div>

    <div id="screen-student" class="screen">
        
        <div class="sidebar" id="main-sidebar">
            
            <div class="menu-parent expanded" onclick="toggleSubmenu('sub-nav', this)">üìÇ KHU V·ª∞C (NAV)</div>
            <div id="sub-nav" class="submenu open"> <div class="menu-child active" onclick="nav('tab-device')" id="btn-tab-device">üè≠ Thi·∫øt B·ªã (Device)</div>
                <div class="menu-child" onclick="nav('tab-electrical')" id="btn-tab-electrical">‚ö° T·ªß ƒêi·ªán (Panel)</div>
                <div class="menu-child" onclick="nav('tab-diagram')" id="btn-tab-diagram">üó∫Ô∏è S∆° ƒê·ªì (Diagram)</div>
                <div class="menu-child" onclick="nav('tab-store')" id="btn-tab-store">üì¶ Kho (Store)</div>
            </div>

            <div class="menu-parent" onclick="toggleSubmenu('sub-tools', this)">üß∞ D·ª§NG C·ª§ (TOOLS)</div>
            <div id="sub-tools" class="submenu">
                <div class="menu-child tool-drag" draggable="true" ondragstart="drag(event)" id="tool-lock">üîí ·ªî Kh√≥a An To√†n</div>
                <div class="menu-child tool-drag" draggable="true" ondragstart="drag(event)" id="tool-tag">üè∑Ô∏è Th·∫ª C·∫£nh B√°o</div>
                <div class="menu-child tool-drag" draggable="true" ondragstart="drag(event)" id="tool-meter">‚ö° ƒê·ªìng H·ªì VOM</div>
                <div class="menu-child" onclick="actionSpeaker()">üì¢ Loa Th√¥ng B√°o</div>
            </div>

            <div id="menu-instructor">
                <div class="menu-parent" onclick="toggleSubmenu('sub-admin', this)" style="color:var(--danger)">üéì GI·∫¢NG VI√äN</div>
                <div id="sub-admin" class="submenu">
                    <div class="menu-child" onclick="forceNav('tab-device')">‚û°Ô∏è ƒê·∫©y HS v·ªÅ M√°y</div>
                    <div class="menu-child" onclick="forceNav('tab-electrical')">‚û°Ô∏è ƒê·∫©y HS v·ªÅ T·ªß ƒêi·ªán</div>
                    <div class="menu-child" onclick="resetApp()" style="color:var(--danger)">‚ö†Ô∏è Reset To√†n B·ªô</div>
                </div>
            </div>

        </div>

        <div class="main-content">
            
            <div id="tab-device" class="tab-view show">
                <h2 style="border-bottom:2px solid var(--primary);">KHU V·ª∞C S·∫¢N XU·∫§T</h2>
                <div class="fan-box">
                    <div class="blade spin" id="blade1"></div>
                    <div class="blade spin" id="blade2" style="transform: rotate(120deg);"></div>
                    <div class="blade spin" id="blade3" style="transform: rotate(240deg);"></div>
                </div>
                <h2 id="machine-state" style="color:var(--success);">M√ÅY ƒêANG CH·∫†Y</h2>
                <div style="display:flex; gap:15px;">
                    <button onclick="setMachine(true)" style="padding:10px 30px; background:var(--success); color:white; border:none; font-weight:bold; cursor:pointer;">START</button>
                    <button onclick="setMachine(false)" style="padding:10px 30px; background:var(--danger); color:white; border:none; font-weight:bold; cursor:pointer;">STOP</button>
                </div>
            </div>

            <div id="tab-electrical" class="tab-view">
                <h2 style="border-bottom:2px solid var(--primary);">T·ª¶ ƒêI·ªÜN PH√ÇN PH·ªêI</h2>
                <div class="panel-grid">
                    <div class="cb-box">
                        <span style="margin-top:10px; font-size:0.8rem;">CB-1 (Light)</span>
                        <div class="cb-lever" onclick="toggleCB(1, this)">ON</div>
                        <div class="drop-zone" ondragover="allow(event)" ondrop="drop(event, 1)"></div>
                    </div>
                    <div class="cb-box" style="border-color:var(--primary);">
                        <span style="margin-top:10px; color:var(--primary); font-weight:bold;">CB-2 (FAN)</span>
                        <div class="cb-lever" id="lev-2" onclick="toggleCB(2, this)">ON</div>
                        <div class="drop-zone" ondragover="allow(event)" ondrop="drop(event, 2)"></div>
                    </div>
                    <div class="cb-box">
                        <span style="margin-top:10px; font-size:0.8rem;">CB-3 (Socket)</span>
                        <div class="cb-lever" onclick="toggleCB(3, this)">ON</div>
                        <div class="drop-zone" ondragover="allow(event)" ondrop="drop(event, 3)"></div>
                    </div>
                </div>
            </div>

            <div id="tab-diagram" class="tab-view">
                <h2 style="border-bottom:2px solid var(--primary);">S∆† ƒê·ªí ƒê∆†N TUY·∫æN</h2>
                <div style="background:white; padding:20px; border-radius:5px; margin-top:20px;">
                    <svg width="400" height="200">
                        <text x="20" y="30" font-weight="bold">380V Main</text>
                        <line x1="40" y1="40" x2="40" y2="180" stroke="red" stroke-width="5"/>
                        <line x1="40" y1="100" x2="150" y2="100" stroke="black" stroke-width="3"/>
                        <rect x="150" y="85" width="50" height="30" fill="none" stroke="blue" stroke-width="2"/>
                        <text x="160" y="105" fill="blue" font-size="12">CB-2</text>
                        <line x1="200" y1="100" x2="300" y2="100" stroke="black" stroke-width="3"/>
                        <circle cx="330" cy="100" r="20" fill="#333"/>
                        <text x="310" y="140" font-weight="bold">FAN</text>
                    </svg>
                </div>
            </div>

             <div id="tab-store" class="tab-view">
                <h2 style="border-bottom:2px solid var(--primary);">KHO V·∫¨T T∆Ø</h2>
                <div style="background:#333; padding:20px; width:100%; max-width:400px; border-radius:8px;">
                    <p>üîí ·ªî kh√≥a: 5</p> <p>üè∑Ô∏è Th·∫ª: 50</p> <p>‚ö° VOM: T·ªët</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        firebase.initializeApp(firebaseConfig);

        let sys = { cb2: true, locked: false, tagged: false, running: true };
        let role = 'guest';

        // --- MENU LOGIC (ACCORDION) ---
        function toggleSidebar() {
            document.getElementById('main-sidebar').classList.toggle('active');
            document.getElementById('menu-backdrop').classList.toggle('show');
        }

        function closeSidebar() {
            document.getElementById('main-sidebar').classList.remove('active');
            document.getElementById('menu-backdrop').classList.remove('show');
        }

        function toggleSubmenu(subId, parentEl) {
            const sub = document.getElementById(subId);
            const isOpen = sub.classList.contains('open');
            
            // ƒê√≥ng t·∫•t c·∫£ submenu kh√°c (t√πy ch·ªçn, ·ªü ƒë√¢y ta gi·ªØ ƒë·ªôc l·∫≠p)
            // if(!isOpen) { document.querySelectorAll('.submenu').forEach(s => s.classList.remove('open')); }

            sub.classList.toggle('open');
            parentEl.classList.toggle('expanded');
        }

        // --- LOGIN & VIEW LOGIC ---
        function doLogin() {
            const p = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(p).then(r => handleUser(r.user)).catch(e => {
                if(location.protocol==='file:') handleUser({email: prompt("Test:", "deptc.gvatvsld@gmail.com")});
            });
        }

        function handleUser(u) {
            document.getElementById('screen-login').classList.remove('show');
            document.getElementById('user-display').innerText = u.email.split('@')[0];
            
            // UNIFIED VIEW: AI C≈®NG V√ÄO M√ÄN H√åNH M√î PH·ªéNG
            document.getElementById('screen-student').classList.add('show');
            nav('tab-device'); // M·∫∑c ƒë·ªãnh m·ªü tab M√°y

            // ROLE CHECK
            if(u.email === 'deptc.gvatvsld@gmail.com') {
                role = 'instructor';
                document.getElementById('menu-instructor').style.display = 'block'; // Hi·ªán menu Admin
                toast("Xin ch√†o Gi·∫£ng vi√™n (Admin Mode)");
            } else {
                role = 'student';
                toast("Xin ch√†o H·ªçc vi√™n");
            }
        }

        // --- NAVIGATION ---
        function nav(tabId) {
            // ƒê·ªïi Tab
            document.querySelectorAll('.tab-view').forEach(t => t.classList.remove('show'));
            document.getElementById(tabId).classList.add('show');
            
            // ƒê·ªïi m√†u Menu
            document.querySelectorAll('.menu-child').forEach(m => m.classList.remove('active'));
            const btn = document.getElementById('btn-'+tabId);
            if(btn) btn.classList.add('active');

            closeSidebar();
        }

        function forceNav(tabId) {
            nav(tabId);
            toast("Gi·∫£ng vi√™n ƒë√£ ƒë·ªïi m√†n h√¨nh");
        }

        // --- SIMULATION ---
        function setMachine(run) {
            if(run && sys.cb2) {
                sys.running = true;
                document.querySelectorAll('.blade').forEach(b => b.style.animation = 'spin 0.2s linear infinite');
                document.getElementById('machine-state').innerText = "M√ÅY ƒêANG CH·∫†Y";
                document.getElementById('machine-state').style.color = "var(--success)";
            } else {
                sys.running = false;
                document.querySelectorAll('.blade').forEach(b => b.style.animation = 'none');
                document.getElementById('machine-state').innerText = "ƒê√É D·ª™NG";
                document.getElementById('machine-state').style.color = "#bdc3c7";
            }
        }

        function toggleCB(id, el) {
            if(id === 2 && sys.locked) { toast("‚õî ƒê√£ kh√≥a LOTO!"); return; }
            if(el.classList.contains('off')) {
                el.classList.remove('off'); el.innerText="ON";
                if(id===2){ sys.cb2=true; setMachine(true); }
            } else {
                el.classList.add('off'); el.innerText="OFF";
                if(id===2){ sys.cb2=false; setMachine(false); }
            }
        }

        // --- DRAG DROP ---
        function drag(e) { e.dataTransfer.setData("t", e.target.id); }
        function allow(e) { e.preventDefault(); }
        function drop(e, id) {
            e.preventDefault();
            const t = e.dataTransfer.getData("t");
            const p = e.target.closest('.cb-box');
            
            if(t==='tool-lock') {
                if(id!==2) { toast("‚ö†Ô∏è Sai CB!"); return; }
                if(sys.cb2) { toast("‚ö° C√≤n ƒëi·ªán!"); return; }
                if(!sys.locked) {
                    sys.locked = true;
                    p.innerHTML += `<div class="vis-lock">üîí</div>`;
                    toast("‚úÖ ƒê√£ kh√≥a");
                }
            } else if(t==='tool-tag') {
                if(id===2 && sys.locked && !sys.tagged) {
                    sys.tagged = true;
                    p.innerHTML += `<div class="vis-tag">üè∑Ô∏è</div>`;
                    toast("‚úÖ ƒê√£ treo th·∫ª");
                } else if(!sys.locked) toast("‚ö†Ô∏è Kh√≥a tr∆∞·ªõc!");
            } else if(t==='tool-meter') {
                toast("‚è≥ ƒêang ƒëo...");
                setTimeout(()=>toast((id===2 && sys.cb2)?"‚ö° 380V (NGUY HI·ªÇM)":"‚úÖ 0V (AN TO√ÄN)"), 1000);
            }
        }

        function actionSpeaker() { toast("üì¢ ƒê√£ ph√°t loa"); closeSidebar(); }
        function resetApp() { location.reload(); }
        function toast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2000);
        }

    </script>
</body>
</html>
