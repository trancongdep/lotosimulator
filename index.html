<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTO Sim v1.7</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-dark: #2f3640;
            --primary: #00a8ff;
            --danger: #e84118;
            --success: #4cd137;
            --text: #f5f6fa;
            --sidebar-w: 260px;
            --header-h: 60px; /* TƒÉng chi·ªÅu cao header ƒë·ªÉ n√∫t d·ªÖ b·∫•m h∆°n */
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text);
            overflow: hidden;
        }

        /* --- HEADER --- */
        .header {
            height: var(--header-h); background: #1e272e;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 2px solid #444;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* BUTTON 3 G·∫†CH (FIXED & HIGH Z-INDEX) */
        #btn-menu {
            background: #353b48; border: 1px solid #718093; color: white;
            font-size: 1.8rem; cursor: pointer; padding: 5px 15px; border-radius: 4px;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        #btn-menu:active { transform: scale(0.95); background: var(--primary); }

        .app-title { font-weight: bold; font-size: 1.2rem; color: var(--primary); }
        .user-info { font-size: 0.9rem; color: #ccc; }

        /* --- SIDEBAR (S·ª¨A L·∫†I LOGIC HI·ªÇN TH·ªä) --- */
        .sidebar {
            position: fixed; 
            top: var(--header-h); 
            bottom: 0;
            left: calc(var(--sidebar-w) * -1); /* ·∫®n sang tr√°i */
            width: var(--sidebar-w);
            background: #222;
            border-right: 1px solid #444;
            transition: left 0.3s ease-in-out; /* Slide effect */
            z-index: 3000; /* Cao h∆°n n·ªôi dung */
            display: flex; flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.7);
        }
        
        .sidebar.active {
            left: 0; /* Hi·ªán ra */
        }

        .menu-group { padding: 10px 0; border-bottom: 1px solid #333; }
        .menu-title { padding: 5px 20px; font-size: 0.75rem; color: #7f8c8d; text-transform: uppercase; }

        .menu-btn {
            width: 100%; padding: 15px 20px;
            background: transparent; border: none; color: #ecf0f1;
            text-align: left; font-size: 1rem; cursor: pointer;
            border-left: 4px solid transparent;
            display: flex; align-items: center; gap: 15px;
        }
        .menu-btn:hover { background: rgba(255,255,255,0.05); }
        .menu-btn.current { border-left-color: var(--primary); background: rgba(0, 168, 255, 0.1); color: var(--primary); }

        .tool-drag { cursor: grab; }
        .tool-drag:active { cursor: grabbing; }

        /* --- BACKDROP (B·∫§M RA NGO√ÄI ƒê·ªÇ ƒê√ìNG) --- */
        .backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2500; display: none;
        }
        .backdrop.show { display: block; }

        /* --- CONTENT AREA --- */
        .main-content {
            margin-top: var(--header-h);
            height: calc(100vh - var(--header-h));
            position: relative;
            background: radial-gradient(at center, #353b48, #2f3640);
        }

        .screen { display: none; height: 100%; width: 100%; }
        .screen.show { display: block; }

        /* --- TAB VIEWS --- */
        .tab-view {
            display: none; height: 100%; width: 100%;
            padding: 20px; box-sizing: border-box;
            flex-direction: column; align-items: center; overflow-y: auto;
        }
        .tab-view.show { display: flex; animation: fadeUp 0.3s; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMPONENT STYLES --- */
        /* Device Fan */
        .fan-box {
            width: 250px; height: 250px; border: 10px solid #95a5a6; border-radius: 50%;
            background: #2c3e50; display: flex; align-items: center; justify-content: center;
            margin: 30px auto; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .blade { width: 220px; height: 30px; background: #bdc3c7; position: absolute; border-radius: 15px; }
        .spin { animation: spin 0.2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Electrical Panel */
        .panel-grid { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .cb-box {
            width: 110px; height: 200px; background: #34495e; border: 2px solid #555; border-radius: 8px;
            position: relative; display: flex; flex-direction: column; align-items: center;
        }
        .cb-lever {
            width: 70px; height: 60px; background: var(--danger); margin-top: 50px; cursor: pointer;
            border-radius: 5px; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center;
            transition: 0.3s; z-index: 10;
        }
        .cb-lever.off { transform: translateY(60px); background: var(--success); }
        .drop-zone { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        
        /* Items */
        .vis-lock { position: absolute; top: 35px; left: 30px; font-size: 3rem; z-index: 20; pointer-events: none; filter: drop-shadow(0 4px 4px #000); }
        .vis-tag { position: absolute; top: 65px; left: 35px; font-size: 2.5rem; z-index: 21; pointer-events: none; transform: rotate(-15deg); filter: drop-shadow(0 4px 4px #000); }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 100px);
            background: #333; color: white; padding: 12px 30px; border-radius: 30px; 
            border: 2px solid var(--primary); font-weight: bold;
            transition: 0.3s; z-index: 4000; opacity: 0;
        }
        .toast.show { transform: translate(-50%, 0); opacity: 1; }

    </style>
</head>
<body>

    <div class="header">
        <div style="display: flex; align-items: center;">
            <button id="btn-menu" onclick="toggleSidebar()">‚ò∞</button>
            <div class="app-title">LOTO Sim v1.7</div>
        </div>
        <div class="user-info" id="user-display">Ch∆∞a ƒëƒÉng nh·∫≠p</div>
    </div>

    <div class="backdrop" id="menu-backdrop" onclick="closeSidebar()"></div>

    <div id="toast" class="toast">H·ªá th·ªëng s·∫µn s√†ng</div>

    <div id="screen-login" class="screen show">
        <div style="height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column;">
            <div style="background:white; padding:40px; border-radius:10px; text-align:center; color:#333;">
                <h1 style="margin-top:0;">ƒêƒÇNG NH·∫¨P H·ªÜ TH·ªêNG</h1>
                <p>M√¥ ph·ªèng quy tr√¨nh kh√≥a h√£m LOTO</p>
                <button onclick="doLogin()" style="padding:15px 30px; background:#e74c3c; color:white; border:none; font-weight:bold; cursor:pointer; font-size:1.1rem; border-radius:5px;">
                    Login with Google
                </button>
                <div style="margin-top:15px; font-size:0.8rem; color:#666;">
                    Gi·∫£ng vi√™n: deptc.gvatvsld@gmail.com
                </div>
            </div>
        </div>
    </div>

    <div id="screen-instructor" class="screen">
        <div style="padding:20px;">
            <div style="background:#353b48; padding:20px; border-radius:8px; margin-bottom:20px;">
                <h2 style="color:var(--primary); margin-top:0;">ƒêI·ªÄU KHI·ªÇN</h2>
                <button class="menu-btn" style="border:1px solid #555; margin-bottom:10px;" onclick="forceNav('tab-device')">‚û°Ô∏è ƒê·∫øn M√°y M√≥c</button>
                <button class="menu-btn" style="border:1px solid #555; margin-bottom:10px;" onclick="forceNav('tab-electrical')">‚û°Ô∏è ƒê·∫øn T·ªß ƒêi·ªán</button>
                <button class="menu-btn" style="border:1px solid #555; margin-bottom:10px;" onclick="forceNav('tab-diagram')">‚û°Ô∏è ƒê·∫øn S∆° ƒê·ªì</button>
                <hr>
                <button onclick="location.reload()" style="width:100%; padding:10px; background:var(--danger); border:none; color:white; font-weight:bold; cursor:pointer;">RESET APP</button>
            </div>
        </div>
    </div>

    <div id="screen-student" class="screen">
        
        <div class="sidebar" id="sidebar-menu">
            <div class="menu-group">
                <div class="menu-title">Di Chuy·ªÉn</div>
                <button class="menu-btn active" onclick="nav('tab-device')" id="btn-tab-device">üè≠ Thi·∫øt B·ªã (Device)</button>
                <button class="menu-btn" onclick="nav('tab-electrical')" id="btn-tab-electrical">‚ö° T·ªß ƒêi·ªán (Panel)</button>
                <button class="menu-btn" onclick="nav('tab-diagram')" id="btn-tab-diagram">üó∫Ô∏è S∆° ƒê·ªì (Diagram)</button>
                <button class="menu-btn" onclick="nav('tab-store')" id="btn-tab-store">üì¶ Kho (Store)</button>
            </div>
            
            <div class="menu-group" style="flex-grow:1;">
                <div class="menu-title">D·ª•ng C·ª• (K√©o th·∫£)</div>
                <div class="menu-btn tool-drag" draggable="true" ondragstart="drag(event)" id="tool-lock">üîí ·ªî Kh√≥a</div>
                <div class="menu-btn tool-drag" draggable="true" ondragstart="drag(event)" id="tool-tag">üè∑Ô∏è Th·∫ª C·∫£nh B√°o</div>
                <div class="menu-btn tool-drag" draggable="true" ondragstart="drag(event)" id="tool-meter">‚ö° ƒê·ªìng H·ªì VOM</div>
                <div class="menu-btn" onclick="actionSpeaker()">üì¢ Loa Th√¥ng B√°o</div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="tab-device" class="tab-view show">
                <h2 style="border-bottom:2px solid var(--primary); text-transform:uppercase;">Khu V·ª±c S·∫£n Xu·∫•t</h2>
                <div class="fan-box">
                    <div class="blade spin" id="blade1"></div>
                    <div class="blade spin" id="blade2" style="transform: rotate(120deg);"></div>
                    <div class="blade spin" id="blade3" style="transform: rotate(240deg);"></div>
                </div>
                <h2 id="machine-state" style="color:var(--success);">M√ÅY ƒêANG CH·∫†Y</h2>
                <div style="display:flex; gap:15px;">
                    <button onclick="setMachine(true)" style="padding:10px 30px; background:var(--success); color:white; border:none; font-weight:bold; cursor:pointer;">START</button>
                    <button onclick="setMachine(false)" style="padding:10px 30px; background:var(--danger); color:white; border:none; font-weight:bold; cursor:pointer;">STOP</button>
                </div>
            </div>

            <div id="tab-electrical" class="tab-view">
                <h2 style="border-bottom:2px solid var(--primary);">T·ªß Ph√¢n Ph·ªëi ƒêi·ªán</h2>
                <p>K√©o d·ª•ng c·ª• t·ª´ Menu v√†o Aptomat</p>
                <div class="panel-grid">
                    <div class="cb-box">
                        <span style="margin-top:10px; font-size:0.8rem;">CB-1 (Light)</span>
                        <div class="cb-lever" onclick="toggleCB(1, this)">ON</div>
                        <div class="drop-zone" ondragover="allow(event)" ondrop="drop(event, 1)"></div>
                    </div>
                    <div class="cb-box" style="border-color:var(--primary);">
                        <span style="margin-top:10px; color:var(--primary); font-weight:bold;">CB-2 (FAN)</span>
                        <div class="cb-lever" id="lev-2" onclick="toggleCB(2, this)">ON</div>
                        <div class="drop-zone" ondragover="allow(event)" ondrop="drop(event, 2)"></div>
                    </div>
                    <div class="cb-box">
                        <span style="margin-top:10px; font-size:0.8rem;">CB-3 (Socket)</span>
                        <div class="cb-lever" onclick="toggleCB(3, this)">ON</div>
                        <div class="drop-zone" ondragover="allow(event)" ondrop="drop(event, 3)"></div>
                    </div>
                </div>
            </div>

            <div id="tab-diagram" class="tab-view">
                <h2 style="border-bottom:2px solid var(--primary);">S∆° ƒê·ªì ƒê∆°n Tuy·∫øn</h2>
                <div style="background:white; padding:20px; border-radius:5px; margin-top:20px;">
                    <svg width="400" height="200">
                        <text x="20" y="30" font-weight="bold">380V Main</text>
                        <line x1="40" y1="40" x2="40" y2="180" stroke="red" stroke-width="5"/>
                        <line x1="40" y1="100" x2="150" y2="100" stroke="black" stroke-width="3"/>
                        <rect x="150" y="85" width="50" height="30" fill="none" stroke="blue" stroke-width="2"/>
                        <text x="160" y="105" fill="blue" font-size="12">CB-2</text>
                        <line x1="200" y1="100" x2="300" y2="100" stroke="black" stroke-width="3"/>
                        <circle cx="330" cy="100" r="20" fill="#333"/>
                        <text x="310" y="140" font-weight="bold">FAN</text>
                    </svg>
                </div>
            </div>
            
            <div id="tab-store" class="tab-view">
                <h2 style="border-bottom:2px solid var(--primary);">Kho D·ª•ng C·ª•</h2>
                <div style="text-align:left; width:100%; max-width:400px; background:#333; padding:20px; border-radius:8px;">
                    <p>üîí Kh√≥a an to√†n: 5</p>
                    <p>üè∑Ô∏è Th·∫ª c·∫£nh b√°o: 50</p>
                    <p>‚ö° ƒê·ªìng h·ªì VOM: OK</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        firebase.initializeApp(firebaseConfig);

        let sys = { cb2: true, locked: false, tagged: false, running: true };
        let role = 'guest';

        // --- 2. MENU LOGIC ---
        function toggleSidebar() {
            document.getElementById('sidebar-menu').classList.toggle('active');
            document.getElementById('menu-backdrop').classList.toggle('show');
        }

        function closeSidebar() {
            document.getElementById('sidebar-menu').classList.remove('active');
            document.getElementById('menu-backdrop').classList.remove('show');
        }

        // --- 3. LOGIN & DEFAULT VIEW ---
        function doLogin() {
            const p = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(p).then(r => handleUser(r.user)).catch(e => {
                if(location.protocol==='file:') handleUser({email: prompt("Email test:", "deptc.gvatvsld@gmail.com")});
            });
        }

        function handleUser(u) {
            document.getElementById('screen-login').classList.remove('show');
            const name = u.email.split('@')[0];
            document.getElementById('user-display').innerText = name;

            if(u.email === 'deptc.gvatvsld@gmail.com') {
                role = 'instructor';
                document.getElementById('screen-instructor').classList.add('show');
            } else {
                role = 'student';
                document.getElementById('screen-student').classList.add('show');
                // *** QUAN TR·ªåNG: M·∫∂C ƒê·ªäNH M·ªû M√ÄN H√åNH THI·∫æT B·ªä ***
                nav('tab-device'); 
                toast("ƒê√£ ƒëƒÉng nh·∫≠p: M√°y ƒëang v·∫≠n h√†nh");
            }
        }

        // --- 4. NAVIGATION ---
        function nav(tabId) {
            // ·∫®n h·∫øt tab
            document.querySelectorAll('.tab-view').forEach(t => t.classList.remove('show'));
            // Hi·ªán tab ƒë√≠ch
            document.getElementById(tabId).classList.add('show');
            
            // Highlight Menu Item
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('current'));
            const btn = document.getElementById('btn-'+tabId);
            if(btn) btn.classList.add('current');

            // T·ª± ƒë√≥ng menu sau khi ch·ªçn
            closeSidebar();
        }

        function forceNav(tabId) {
            nav(tabId);
            toast("Gi·∫£ng vi√™n ƒë√£ chuy·ªÉn m√†n h√¨nh");
        }

        // --- 5. SIMULATION LOGIC ---
        function setMachine(run) {
            if(run && sys.cb2) {
                sys.running = true;
                document.querySelectorAll('.blade').forEach(b => b.style.animation = 'spin 0.2s linear infinite');
                document.getElementById('machine-state').innerText = "M√ÅY ƒêANG CH·∫†Y";
                document.getElementById('machine-state').style.color = "var(--success)";
            } else {
                sys.running = false;
                document.querySelectorAll('.blade').forEach(b => b.style.animation = 'none');
                document.getElementById('machine-state').innerText = "ƒê√É D·ª™NG";
                document.getElementById('machine-state').style.color = "#bdc3c7";
            }
        }

        function toggleCB(id, el) {
            if(id === 2 && sys.locked) { toast("‚õî ƒê√£ kh√≥a LOTO!"); return; }
            
            if(el.classList.contains('off')) {
                el.classList.remove('off'); el.innerText = "ON";
                if(id === 2) { sys.cb2 = true; setMachine(true); }
            } else {
                el.classList.add('off'); el.innerText = "OFF";
                if(id === 2) { sys.cb2 = false; setMachine(false); }
            }
        }

        // --- 6. DRAG & DROP ---
        function drag(e) { e.dataTransfer.setData("t", e.target.id); }
        function allow(e) { e.preventDefault(); }
        function drop(e, id) {
            e.preventDefault();
            const t = e.dataTransfer.getData("t");
            const parent = e.target.closest('.cb-box'); // T√¨m container cha
            
            if(t==='tool-lock') {
                if(id!==2) { toast("‚ö†Ô∏è Sai CB!"); return; }
                if(sys.cb2) { toast("‚ö° C√≤n ƒëi·ªán! C·∫Øt CB tr∆∞·ªõc."); return; }
                if(!sys.locked) {
                    sys.locked = true;
                    parent.innerHTML += `<div class="vis-lock">üîí</div>`;
                    toast("‚úÖ ƒê√£ kh√≥a an to√†n");
                }
            } else if(t==='tool-tag') {
                if(id===2 && sys.locked && !sys.tagged) {
                    sys.tagged = true;
                    parent.innerHTML += `<div class="vis-tag">üè∑Ô∏è</div>`;
                    toast("‚úÖ ƒê√£ treo th·∫ª");
                } else if(!sys.locked) toast("‚ö†Ô∏è Ph·∫£i kh√≥a tr∆∞·ªõc!");
            } else if(t==='tool-meter') {
                toast("‚è≥ ƒêang ƒëo...");
                setTimeout(() => toast((id===2 && sys.cb2) ? "‚ö° 380V (NGUY HI·ªÇM)" : "‚úÖ 0V (AN TO√ÄN)"), 1000);
            }
        }

        function actionSpeaker() {
            toast("üì¢ ƒê√£ ph√°t loa th√¥ng b√°o");
            closeSidebar();
        }

        // --- UTILS ---
        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2000);
        }

    </script>
</body>
</html>
