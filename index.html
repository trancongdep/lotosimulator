<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTO Sim v1.5</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-dark: #2f3640;
            --sidebar-collapsed: 60px;
            --sidebar-expanded: 240px; /* R√∫t g·ªçn chi·ªÅu r·ªông m·ªü r·ªông */
            --primary: #00a8ff;
            --secondary: #9c88ff;
            --danger: #e84118;
            --success: #4cd137;
            --text-color: #f5f6fa;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-color);
            overflow: hidden;
        }

        /* --- HEADER (COMPACT) --- */
        .header {
            height: 40px; background: #1e272e;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid #444;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
        }
        .app-title { font-weight: bold; letter-spacing: 1px; color: var(--primary); font-size: 1rem;}
        .version-badge { font-size: 0.75rem; background: #444; color: white; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }
        .user-display { 
            font-size: 0.9rem; color: #dcdde1; 
            max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        /* --- SIDEBAR (NAVIGATION + TOOLS) --- */
        .sidebar {
            position: fixed; left: 0; top: 40px; bottom: 0;
            width: var(--sidebar-collapsed);
            background: #2f3640;
            border-right: 1px solid #444;
            display: flex; flex-direction: column;
            transition: width 0.2s ease-in-out;
            z-index: 1000; overflow: hidden;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }
        
        .sidebar:hover { width: var(--sidebar-expanded); }

        /* Sidebar Section Headers */
        .sb-header {
            padding: 15px 0 5px 20px; font-size: 0.7rem; color: #718093; 
            text-transform: uppercase; white-space: nowrap; opacity: 0; transition: 0.2s;
        }
        .sidebar:hover .sb-header { opacity: 1; }

        /* Menu Items */
        .menu-item {
            display: flex; align-items: center;
            height: 45px; width: 100%;
            background: transparent; border: none;
            color: #dcdde1; cursor: pointer;
            transition: 0.2s; text-decoration: none; padding: 0;
        }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .menu-item.active { background: rgba(0, 168, 255, 0.1); border-left: 3px solid var(--primary); color: var(--primary); }

        .menu-icon {
            width: var(--sidebar-collapsed); min-width: var(--sidebar-collapsed);
            text-align: center; font-size: 1.2rem;
        }
        .menu-label {
            white-space: nowrap; opacity: 0; transition: 0.2s; font-size: 0.9rem;
        }
        .sidebar:hover .menu-label { opacity: 1; }

        /* Draggable Tools */
        .tool-item { cursor: grab; }
        .tool-item:active { cursor: grabbing; }
        .tool-item .menu-icon { color: var(--secondary); } 

        /* --- MAIN CONTENT AREA --- */
        .content-area {
            margin-left: var(--sidebar-collapsed);
            padding-top: 40px; height: 100vh; box-sizing: border-box;
            background: radial-gradient(circle at center, #353b48 0%, #2f3640 100%);
        }

        .screen { display: none; height: 100%; width: 100%; }
        .screen.active { display: block; }
        
        /* Views (Tabs) */
        .view-tab {
            display: none; height: 100%; padding: 20px; box-sizing: border-box;
            flex-direction: column; align-items: center; justify-content: flex-start;
            animation: fadeIn 0.3s; overflow-y: auto;
        }
        .view-tab.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- ELEMENTS --- */
        .panel { background: #353b48; padding: 20px; border-radius: 8px; border: 1px solid #555; }
        
        /* Fan */
        .fan-frame {
            width: 200px; height: 200px; border: 8px solid #7f8c8d; border-radius: 50%;
            background: #222; display: flex; align-items: center; justify-content: center; margin: 20px;
        }
        .fan-blade { width: 180px; height: 20px; background: silver; position: absolute; border-radius: 10px; }
        .spin { animation: spin 0.2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Electrical Panel */
        .elec-box {
            display: flex; gap: 15px; background: #bdc3c7; padding: 20px; border-radius: 5px; border: 3px solid #2c3e50;
        }
        .cb-switch {
            width: 80px; height: 160px; background: #2f3640; border-radius: 4px; position: relative;
            display: flex; flex-direction: column; align-items: center; border: 2px solid #555;
        }
        .cb-lever {
            width: 60px; height: 50px; background: var(--danger); margin-top: 30px; cursor: pointer;
            border-radius: 3px; z-index: 10; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; transition: 0.3s;
        }
        .cb-lever.off { transform: translateY(50px); background: var(--success); }
        .drop-zone { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 5; }

        /* Visuals */
        .v-lock { position: absolute; top: 20px; left: 15px; font-size: 2.5rem; pointer-events: none; z-index: 20; filter: drop-shadow(2px 2px 2px black); }
        .v-tag { position: absolute; top: 50px; left: 20px; font-size: 2rem; pointer-events: none; z-index: 21; filter: drop-shadow(2px 2px 2px black); transform: rotate(-10deg); }

        /* Toast */
        .toast {
            position: fixed; bottom: 20px; right: 20px; 
            background: #333; color: white; padding: 10px 20px; border-radius: 4px; border-left: 4px solid var(--primary);
            transform: translateY(100px); transition: 0.3s; z-index: 3000;
        }
        .toast.show { transform: translateY(0); }

    </style>
</head>
<body>

    <div class="header">
        <div class="app-title">LOTO Sim <span class="version-badge">v1.5</span></div>
        <div class="user-display" id="header-user">Guest</div>
    </div>

    <div id="toast" class="toast">H·ªá th·ªëng s·∫µn s√†ng</div>

    <div id="login-screen" class="screen active" style="display: flex; align-items: center; justify-content: center;">
        <div style="text-align: center; background: white; padding: 30px; border-radius: 8px; color: #333;">
            <h2 style="margin-top:0;">ƒêƒÇNG NH·∫¨P</h2>
            <button onclick="doLogin()" style="padding:10px 20px; background: #e74c3c; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">
                Google Login
            </button>
            <div style="margin-top:15px; font-size: 0.8rem; color: #888;">Gi·∫£ng vi√™n: deptc...</div>
        </div>
    </div>

    <div id="instructor-screen" class="screen">
        <div class="content-area" style="margin-left:0; padding: 60px 20px;">
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div class="panel">
                    <h3 style="color:var(--primary); margin-top:0;">ƒêI·ªÄU KHI·ªÇN</h3>
                    <button class="menu-item active" style="border:1px solid #555; margin-bottom:5px;" onclick="forceStudent('view-device')">üè≠ ƒê·∫øn M√°y M√≥c</button>
                    <button class="menu-item active" style="border:1px solid #555; margin-bottom:5px;" onclick="forceStudent('view-electrical')">‚ö° ƒê·∫øn T·ªß ƒêi·ªán</button>
                    <button class="menu-item active" style="border:1px solid #555; margin-bottom:5px;" onclick="forceStudent('view-diagram')">üó∫Ô∏è ƒê·∫øn S∆° ƒê·ªì</button>
                    <hr style="border-color:#555">
                    <button onclick="resetApp()" style="width:100%; padding:8px; background:var(--danger); border:none; color:white; cursor:pointer;">RESET APP</button>
                </div>
                <div class="panel" id="inst-log" style="font-family: monospace; color: #00d2d3; max-height: 400px; overflow-y: auto;">
                    > System initiated.<br>
                </div>
            </div>
            <button onclick="toggleRoles()" style="position:fixed; bottom:10px; left:10px; opacity:0.5;">Switch View</button>
        </div>
    </div>

    <div id="student-screen" class="screen">
        
        <div class="sidebar">
            <div class="sb-header">MENU ƒêI·ªÄU H∆Ø·ªöNG</div>
            
            <button class="menu-item active" onclick="navTo('view-device')" id="btn-view-device">
                <div class="menu-icon">üè≠</div>
                <div class="menu-label">M√°y M√≥c (Device)</div>
            </button>

            <button class="menu-item" onclick="navTo('view-electrical')" id="btn-view-electrical">
                <div class="menu-icon">‚ö°</div>
                <div class="menu-label">T·ªß ƒêi·ªán (Panel)</div>
            </button>

            <button class="menu-item" onclick="navTo('view-diagram')" id="btn-view-diagram">
                <div class="menu-icon">üó∫Ô∏è</div>
                <div class="menu-label">S∆° ƒê·ªì (Diagram)</div>
            </button>

            <button class="menu-item" onclick="navTo('view-store')" id="btn-view-store">
                <div class="menu-icon">üì¶</div>
                <div class="menu-label">Kho (Inventory)</div>
            </button>

            <div style="flex-grow:1"></div>

            <div class="sb-header">D·ª§NG C·ª§ (K√âO TH·∫¢)</div>
            
            <div class="menu-item tool-item" draggable="true" ondragstart="drag(event)" id="tool-lock">
                <div class="menu-icon">üîí</div>
                <div class="menu-label">·ªî Kh√≥a</div>
            </div>

            <div class="menu-item tool-item" draggable="true" ondragstart="drag(event)" id="tool-tag">
                <div class="menu-icon">üè∑Ô∏è</div>
                <div class="menu-label">Th·∫ª C·∫£nh B√°o</div>
            </div>

            <div class="menu-item tool-item" draggable="true" ondragstart="drag(event)" id="tool-meter">
                <div class="menu-icon">‚ö°</div>
                <div class="menu-label">ƒê·ªìng H·ªì ƒêo</div>
            </div>

             <div class="menu-item tool-item" onclick="actionSpeaker()">
                <div class="menu-icon">üì¢</div>
                <div class="menu-label">Loa Th√¥ng B√°o</div>
            </div>
        </div>

        <div class="content-area">
            
            <div id="view-device" class="view-tab active">
                <h2 style="border-bottom:2px solid var(--primary); width:100%;">M√ÅY QU·∫†T S·ªê 02</h2>
                <div class="fan-frame">
                    <div class="fan-blade spin" id="fan"></div>
                    <div class="fan-blade spin" style="transform: rotate(120deg);"></div>
                    <div class="fan-blade spin" style="transform: rotate(240deg);"></div>
                </div>
                <div style="text-align: center;">
                    <div id="st-machine" style="color:var(--success); font-weight:bold; font-size:1.2rem; margin-bottom:10px;">ƒêANG CH·∫†Y</div>
                    <button onclick="setMachine(true)" style="padding:8px 20px; background:var(--success); border:none; color:white;">START</button>
                    <button onclick="setMachine(false)" style="padding:8px 20px; background:var(--danger); border:none; color:white;">STOP</button>
                </div>
            </div>

            <div id="view-electrical" class="view-tab">
                <h2 style="border-bottom:2px solid var(--primary); width:100%;">T·ª¶ ƒêI·ªÜN DB-01</h2>
                <div class="elec-box">
                    <div class="cb-switch">
                        <span style="font-size:0.7rem; margin-top:5px; color:#aaa">CB-1 (Light)</span>
                        <div class="cb-lever" onclick="toggleCB(1, this)">ON</div>
                        <div class="drop-zone" id="dz-1" ondragover="allow(event)" ondrop="drop(event, 1)"></div>
                    </div>
                    <div class="cb-switch" style="border-color: var(--primary);">
                        <span style="font-size:0.7rem; margin-top:5px; color:var(--primary); font-weight:bold;">CB-2 (FAN)</span>
                        <div class="cb-lever" id="lev-2" onclick="toggleCB(2, this)">ON</div>
                        <div class="drop-zone" id="dz-2" ondragover="allow(event)" ondrop="drop(event, 2)"></div>
                    </div>
                    <div class="cb-switch">
                        <span style="font-size:0.7rem; margin-top:5px; color:#aaa">CB-3 (Aux)</span>
                        <div class="cb-lever" onclick="toggleCB(3, this)">ON</div>
                        <div class="drop-zone" id="dz-3" ondragover="allow(event)" ondrop="drop(event, 3)"></div>
                    </div>
                </div>
                <p style="margin-top:20px; color:#999; font-size:0.9rem;">*G·ª£i √Ω: D√πng Kh√≥a v√† Th·∫ª trong menu b√™n tr√°i.</p>
            </div>

            <div id="view-diagram" class="view-tab">
                <h2 style="border-bottom:2px solid var(--primary); width:100%;">S∆† ƒê·ªí ƒêI·ªÜN</h2>
                <div style="background:white; padding:20px; border-radius:5px;">
                    <svg width="400" height="200" viewBox="0 0 400 200">
                        <rect width="400" height="200" fill="white" />
                        <text x="20" y="30" font-weight="bold">380V Main</text>
                        <line x1="40" y1="40" x2="40" y2="180" stroke="red" stroke-width="4"/>
                        <line x1="40" y1="100" x2="150" y2="100" stroke="black" stroke-width="2"/>
                        <rect x="150" y="85" width="40" height="30" fill="none" stroke="blue" stroke-width="2"/>
                        <text x="155" y="105" font-size="12" fill="blue">CB-2</text>
                        <line x1="190" y1="100" x2="300" y2="100" stroke="black" stroke-width="2"/>
                        <circle cx="320" cy="100" r="15" fill="#333"/>
                        <text x="310" y="140" font-size="12" font-weight="bold">FAN</text>
                    </svg>
                </div>
            </div>

            <div id="view-store" class="view-tab">
                <h2 style="border-bottom:2px solid var(--primary); width:100%;">KHO V·∫¨T T∆Ø</h2>
                <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px; width:100%;">
                    <div class="panel">üîí KH√ìA: 5</div>
                    <div class="panel">üè∑Ô∏è TH·∫∫: 50</div>
                    <div class="panel">‚ö° ƒê·ªíNG H·ªí: OK</div>
                    <div class="panel">üß§ GƒÇNG TAY: OK</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // INIT
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        firebase.initializeApp(firebaseConfig);
        
        let role = 'guest';
        let sys = { cb2: true, locked: false, tagged: false, running: true };

        // LOGIN
        function doLogin() {
            const p = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(p).then(r => setRole(r.user)).catch(e => {
                if(location.protocol==='file:') setRole({email: prompt("Test Email:", "deptc.gvatvsld@gmail.com")});
            });
        }
        function setRole(u) {
            document.getElementById('login-screen').classList.remove('active');
            // Shorten email: deptc.gvatvsld@gmail.com -> deptc.gvatvsld
            const shortName = u.email.split('@')[0];
            document.getElementById('header-user').innerText = shortName;

            if(u.email === 'deptc.gvatvsld@gmail.com') {
                role = 'instructor';
                document.getElementById('instructor-screen').classList.add('active');
            } else {
                role = 'student';
                document.getElementById('student-screen').classList.add('active');
            }
        }

        // NAVIGATION
        function navTo(viewId) {
            // Hide all tabs
            document.querySelectorAll('.view-tab').forEach(el => el.classList.remove('active'));
            // Show target
            document.getElementById(viewId).classList.add('active');
            
            // Sidebar Active State
            document.querySelectorAll('.menu-item').forEach(b => b.classList.remove('active'));
            const btnId = 'btn-' + viewId;
            if(document.getElementById(btnId)) document.getElementById(btnId).classList.add('active');
            
            msg(`Chuy·ªÉn ƒë·∫øn: ${viewId.replace('view-','')}`);
        }

        function forceStudent(viewId) {
            navTo(viewId); // Local sim
            msg("Gi·∫£ng vi√™n y√™u c·∫ßu chuy·ªÉn m√†n h√¨nh.");
        }

        // ACTIONS
        function setMachine(run) {
            if(run && sys.cb2) {
                sys.running = true;
                document.querySelectorAll('.fan-blade').forEach(b => b.style.animation = 'spin 0.2s linear infinite');
                document.getElementById('st-machine').innerText = 'ƒêANG CH·∫†Y';
                document.getElementById('st-machine').style.color = 'var(--success)';
            } else {
                sys.running = false;
                document.querySelectorAll('.fan-blade').forEach(b => b.style.animation = 'none');
                document.getElementById('st-machine').innerText = 'ƒê√É D·ª™NG';
                document.getElementById('st-machine').style.color = '#bdc3c7';
            }
        }

        function toggleCB(id, el) {
            if(id === 2 && sys.locked) { msg("‚õî ƒê√£ kh√≥a LOTO!"); return; }
            
            if(el.classList.contains('off')) {
                el.classList.remove('off'); el.innerText = "ON";
                if(id === 2) { sys.cb2 = true; setMachine(true); }
            } else {
                el.classList.add('off'); el.innerText = "OFF";
                if(id === 2) { sys.cb2 = false; setMachine(false); }
            }
        }

        // DRAG DROP
        function drag(e) { e.dataTransfer.setData("t", e.target.id); }
        function allow(e) { e.preventDefault(); }
        function drop(e, id) {
            e.preventDefault();
            const t = e.dataTransfer.getData("t");
            const z = document.getElementById('dz-'+id);
            
            if(t==='tool-lock') {
                if(id!==2) { msg("‚ö†Ô∏è Sai CB!"); return; }
                if(sys.cb2) { msg("‚ö° C√≤n ƒëi·ªán!"); return; }
                if(!sys.locked) {
                    sys.locked = true;
                    z.innerHTML += `<div class="v-lock">üîí</div>`;
                    msg("‚úÖ ƒê√£ kh√≥a.");
                    log("User locked CB2");
                }
            } else if(t==='tool-tag') {
                if(id===2 && sys.locked && !sys.tagged) {
                    sys.tagged = true;
                    z.innerHTML += `<div class="v-tag">üè∑Ô∏è</div>`;
                    msg("‚úÖ ƒê√£ treo th·∫ª.");
                } else msg("‚ö†Ô∏è Ch∆∞a kh√≥a!");
            } else if(t==='tool-meter') {
                msg("‚è≥ ƒêang ƒëo...");
                setTimeout(() => msg((id===2 && sys.cb2) ? "‚ö° 380V" : "‚úÖ 0V"), 1000);
            }
        }

        function actionSpeaker() { msg("üì¢ ƒê√£ th√¥ng b√°o."); log("User announced."); }

        // UTILS
        function msg(txt) {
            const t = document.getElementById('toast');
            t.innerText = txt; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2000);
        }
        function log(txt) {
            const l = document.getElementById('inst-log');
            if(l) l.innerHTML += `<div>> ${txt}</div>`;
        }
        function resetApp() { location.reload(); }
        function toggleRoles() {
            const inst = document.getElementById('instructor-screen');
            const stu = document.getElementById('student-screen');
            if(inst.classList.contains('active')) { inst.classList.remove('active'); stu.classList.add('active'); }
            else { stu.classList.remove('active'); inst.classList.add('active'); }
        }

    </script>
</body>
</html>
