<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTO Sim v1.4 - Unified Sidebar</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-dark: #2f3640;
            --sidebar-collapsed: 60px;
            --sidebar-expanded: 260px;
            --primary: #00a8ff;
            --secondary: #9c88ff;
            --danger: #e84118;
            --success: #4cd137;
            --text-color: #f5f6fa;
            --panel-bg: #353b48;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-color);
            overflow: hidden;
        }

        /* --- HEADER (INFO ONLY) --- */
        .header {
            height: 40px; background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid #555;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 500;
        }
        .app-ver { font-size: 0.8rem; background: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 10px; color: white;}

        /* --- UNIFIED SIDEBAR --- */
        .sidebar {
            position: fixed; left: 0; top: 40px; bottom: 0;
            width: var(--sidebar-collapsed);
            background: #1e272e;
            border-right: 1px solid #444;
            display: flex; flex-direction: column;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000; overflow: hidden;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }
        
        .sidebar:hover { width: var(--sidebar-expanded); }

        /* Sidebar Groups */
        .sb-group {
            padding: 10px 0;
            border-bottom: 1px solid #353b48;
        }
        .sb-title {
            padding-left: 20px; margin-bottom: 5px;
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
            color: #7f8c8d; white-space: nowrap; opacity: 0; transition: 0.2s;
        }
        .sidebar:hover .sb-title { opacity: 1; }

        /* Sidebar Items (Nav Buttons & Draggables) */
        .sb-item {
            display: flex; align-items: center;
            height: 50px; width: 100%;
            padding: 0; margin: 2px 0;
            background: transparent; border: none;
            color: #dcdde1; cursor: pointer;
            transition: background 0.2s, color 0.2s;
            text-decoration: none;
        }
        .sb-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .sb-item.active { background: rgba(0, 168, 255, 0.15); border-left: 4px solid var(--primary); }

        .sb-icon {
            width: var(--sidebar-collapsed); min-width: var(--sidebar-collapsed);
            text-align: center; font-size: 1.5rem;
        }
        .sb-label {
            white-space: nowrap; opacity: 0; transition: 0.2s; font-size: 1rem;
        }
        .sidebar:hover .sb-label { opacity: 1; }

        /* Distinction for Draggable items */
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; }
        .draggable-item .sb-icon { color: var(--secondary); } /* Tools have purple icons */

        /* --- MAIN CONTENT --- */
        .main-container {
            margin-left: var(--sidebar-collapsed);
            padding-top: 40px; height: 100vh; box-sizing: border-box;
            transition: margin-left 0.3s;
            background: url('https://www.transparenttextures.com/patterns/dark-matter.png'), linear-gradient(to bottom, #2f3640, #353b48);
        }

        .screen { display: none; height: 100%; width: 100%; }
        .screen.active { display: block; }
        
        /* Tab Views inside Student Screen */
        .tab-view {
            display: none; height: 100%; padding: 20px; box-sizing: border-box;
            flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 0.4s;
        }
        .tab-view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* --- COMPONENT STYLES --- */
        /* Login */
        .login-box {
            text-align: center; background: white; color: #333; padding: 40px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        
        /* Instructor Panel */
        .inst-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; height: 100%; padding: 20px; }
        .inst-card { background: rgba(0,0,0,0.2); border: 1px solid #555; padding: 20px; border-radius: 8px; overflow-y: auto;}

        /* Simulation Visuals */
        .fan-container {
            width: 250px; height: 250px; border: 10px solid #7f8c8d; border-radius: 50%;
            background: #222; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
        }
        .blade { width: 220px; height: 25px; background: silver; position: absolute; border-radius: 12px; }
        .spin { animation: spin 0.2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Panel CBs */
        .panel-board {
            display: flex; gap: 20px; background: #bdc3c7; padding: 30px; border-radius: 10px; border: 5px solid #2c3e50;
        }
        .cb-mod {
            width: 100px; height: 200px; background: #34495e; border-radius: 4px; position: relative;
            display: flex; flex-direction: column; align-items: center; border: 2px solid #2c3e50;
        }
        .switch-handle {
            width: 70px; height: 60px; background: var(--danger); margin-top: 40px; cursor: pointer;
            border-radius: 4px; transition: 0.3s; z-index: 5;
            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;
        }
        .switch-handle.off { transform: translateY(60px); background: var(--success); }
        .drop-target {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
        }

        /* Items Visuals */
        .visual-lock { position: absolute; top: 30px; left: 25px; font-size: 3rem; pointer-events: none; z-index: 20; filter: drop-shadow(2px 2px 2px black);}
        .visual-tag { position: absolute; top: 60px; left: 30px; font-size: 2.5rem; pointer-events: none; z-index: 21; filter: drop-shadow(2px 2px 2px black); transform: rotate(-10deg);}

        /* Toast */
        .toast {
            position: fixed; bottom: 20px; right: 20px; 
            background: #333; border-left: 5px solid var(--primary); color: white;
            padding: 15px 25px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: translateX(200%); transition: 0.3s; z-index: 2000;
        }
        .toast.active { transform: translateX(0); }

    </style>
</head>
<body>

    <div class="header">
        <div style="font-weight: bold; letter-spacing: 1px;">LOTO TRAINING <span class="app-ver">Ver 1.4</span></div>
        <div id="user-display" style="font-size: 0.9rem; opacity: 0.8;">Guest</div>
    </div>

    <div id="toast" class="toast">Th√¥ng b√°o h·ªá th·ªëng</div>

    <div id="login-screen" class="screen active" style="display: flex; align-items: center; justify-content: center;">
        <div class="login-box">
            <h1 style="color:#2c3e50; margin-top:0;">ƒêƒÇNG NH·∫¨P</h1>
            <p>Ch·ªçn ph∆∞∆°ng th·ª©c ƒë·ªÉ b·∫Øt ƒë·∫ßu b√†i h·ªçc LOTO</p>
            <button onclick="authLogin()" style="padding:12px 25px; background: #e74c3c; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 30px; font-size: 1rem;">
                Login with Google
            </button>
            <p style="margin-top:20px; font-size:0.8rem; color:#7f8c8d;">Gi·∫£ng vi√™n: deptc.gvatvsld@gmail.com</p>
        </div>
    </div>

    <div id="instructor-screen" class="screen">
        <div class="main-container" style="margin-left:0; padding: 60px 20px 20px 20px;">
            <div class="inst-grid">
                <div class="inst-card">
                    <h3 style="color: var(--primary); margin-top:0;">ƒêI·ªÄU KHI·ªÇN L·ªöP H·ªåC</h3>
                    <p>Chuy·ªÉn m√†n h√¨nh h·ªçc vi√™n ƒë·∫øn:</p>
                    <button class="sb-item active" onclick="forceTab('tab-device')" style="border: 1px solid #555; margin-bottom: 5px; border-radius: 4px;">üè≠ Khu V·ª±c M√°y</button>
                    <button class="sb-item active" onclick="forceTab('tab-electrical')" style="border: 1px solid #555; margin-bottom: 5px; border-radius: 4px;">‚ö° T·ªß ƒêi·ªán (CB)</button>
                    <button class="sb-item active" onclick="forceTab('tab-diagram')" style="border: 1px solid #555; margin-bottom: 5px; border-radius: 4px;">üó∫Ô∏è S∆° ƒê·ªì ƒêi·ªán</button>
                    
                    <hr style="border-color: #555; margin: 20px 0;">
                    <button onclick="location.reload()" style="width:100%; padding:10px; background:var(--danger); color:white; border:none; font-weight:bold; cursor:pointer;">RESET SIMULATION</button>
                </div>
                <div class="inst-card" id="inst-logs">
                    <h3 style="color: var(--success); margin-top:0;">NH·∫¨T K√ù THAO T√ÅC</h3>
                    </div>
            </div>
        </div>
        <button onclick="toggleView()" style="position:fixed; bottom:20px; left:20px; z-index:9999; padding:10px;">üëÅÔ∏è Xem m√†n h√¨nh H·ªçc vi√™n</button>
    </div>

    <div id="student-screen" class="screen">
        
        <div class="sidebar">
            
            <div class="sb-group">
                <div class="sb-title">Khu V·ª±c (Navigation)</div>
                
                <button class="sb-item active" onclick="switchTab('tab-device')" id="nav-device">
                    <div class="sb-icon">üè≠</div>
                    <div class="sb-label">M√°y M√≥c (Device)</div>
                </button>

                <button class="sb-item" onclick="switchTab('tab-electrical')" id="nav-electrical">
                    <div class="sb-icon">‚ö°</div>
                    <div class="sb-label">T·ªß ƒêi·ªán (Panel)</div>
                </button>

                <button class="sb-item" onclick="switchTab('tab-diagram')" id="nav-diagram">
                    <div class="sb-icon">üó∫Ô∏è</div>
                    <div class="sb-label">S∆° ƒê·ªì (Diagram)</div>
                </button>

                <button class="sb-item" onclick="switchTab('tab-store')" id="nav-store">
                    <div class="sb-icon">üìã</div>
                    <div class="sb-label">Kho (Inventory)</div>
                </button>
            </div>

            <div class="sb-group" style="flex-grow: 1;">
                <div class="sb-title">T√∫i ƒê·ªì Ngh·ªÅ (Tools)</div>

                <div class="sb-item draggable-item" draggable="true" ondragstart="drag(event)" id="tool-lock">
                    <div class="sb-icon">üîí</div>
                    <div class="sb-label">·ªî Kh√≥a (Lock)</div>
                </div>

                <div class="sb-item draggable-item" draggable="true" ondragstart="drag(event)" id="tool-tag">
                    <div class="sb-icon">üè∑Ô∏è</div>
                    <div class="sb-label">Th·∫ª (Tag)</div>
                </div>

                <div class="sb-item draggable-item" draggable="true" ondragstart="drag(event)" id="tool-meter">
                    <div class="sb-icon">‚ö°</div>
                    <div class="sb-label">ƒê·ªìng h·ªì (VOM)</div>
                </div>

                <div class="sb-item draggable-item" draggable="true" ondragstart="drag(event)" id="tool-speaker" onclick="actionNotify()">
                    <div class="sb-icon">üì¢</div>
                    <div class="sb-label">Loa Th√¥ng B√°o</div>
                </div>
            </div>
        </div>

        <div class="main-container">
            
            <div id="tab-device" class="tab-view active">
                <h2 style="border-bottom: 2px solid var(--primary); padding-bottom:10px;">KHU V·ª∞C S·∫¢N XU·∫§T: QU·∫†T S·ªê 2</h2>
                <div class="fan-container">
                    <div class="blade spin" id="fan-blades"></div>
                    <div class="blade spin" style="transform: rotate(120deg);"></div>
                    <div class="blade spin" style="transform: rotate(240deg);"></div>
                </div>
                <div style="text-align:center;">
                    <div id="status-text" style="font-size:1.5rem; font-weight:bold; color:var(--success); margin-bottom:15px;">ƒêANG CH·∫†Y</div>
                    <button onclick="machineControl(true)" style="padding:10px 30px; background:var(--success); border:none; color:white; font-weight:bold; cursor:pointer; margin-right:10px;">START</button>
                    <button onclick="machineControl(false)" style="padding:10px 30px; background:var(--danger); border:none; color:white; font-weight:bold; cursor:pointer;">STOP</button>
                </div>
            </div>

            <div id="tab-electrical" class="tab-view">
                <h2 style="border-bottom: 2px solid var(--primary); padding-bottom:10px;">T·ª¶ ƒêI·ªÜN PH√ÇN PH·ªêI DB-01</h2>
                <div class="panel-board">
                    <div class="cb-mod">
                        <span style="color:#ccc; margin-top:5px; font-size:0.8rem;">CB-01 (ƒê√®n)</span>
                        <div class="switch-handle" onclick="toggleSwitch(1, this)">ON</div>
                        <div class="drop-target" id="zone-1" ondragover="allowDrop(event)" ondrop="drop(event, 1)"></div>
                    </div>
                    <div class="cb-mod" style="border-color: var(--primary);">
                        <span style="color:var(--primary); margin-top:5px; font-weight:bold;">CB-02 (Qu·∫°t)</span>
                        <div class="switch-handle" id="handle-2" onclick="toggleSwitch(2, this)">ON</div>
                        <div class="drop-target" id="zone-2" ondragover="allowDrop(event)" ondrop="drop(event, 2)"></div>
                    </div>
                    <div class="cb-mod">
                        <span style="color:#ccc; margin-top:5px; font-size:0.8rem;">CB-03 (Socket)</span>
                        <div class="switch-handle" onclick="toggleSwitch(3, this)">ON</div>
                        <div class="drop-target" id="zone-3" ondragover="allowDrop(event)" ondrop="drop(event, 3)"></div>
                    </div>
                </div>
                <p style="margin-top:20px; color:#bdc3c7;">*M·ªü Sidebar b√™n tr√°i ƒë·ªÉ l·∫•y d·ª•ng c·ª• kh√≥a/th·∫ª.</p>
            </div>

            <div id="tab-diagram" class="tab-view">
                <h2 style="border-bottom: 2px solid var(--primary); padding-bottom:10px;">S∆† ƒê·ªí NGUY√äN L√ù</h2>
                <div style="background:white; padding:20px; border-radius:8px;">
                    <svg width="500" height="300" viewBox="0 0 500 300">
                        <rect x="10" y="10" width="480" height="280" fill="none" stroke="black"/>
                        <text x="30" y="40" font-weight="bold">NGU·ªíN T·ªîNG 380V</text>
                        <line x1="50" y1="50" x2="50" y2="250" stroke="red" stroke-width="5"/>
                        
                        <line x1="50" y1="150" x2="200" y2="150" stroke="black" stroke-width="2"/>
                        <rect x="200" y="130" width="50" height="40" fill="none" stroke="blue" stroke-width="2"/>
                        <text x="210" y="155" fill="blue" font-weight="bold">CB-02</text>
                        <line x1="250" y1="150" x2="350" y2="150" stroke="black" stroke-width="2"/>
                        <circle cx="380" cy="150" r="20" fill="#333"/>
                        <text x="360" y="190" font-weight="bold">MOTOR QU·∫†T</text>
                    </svg>
                </div>
            </div>

            <div id="tab-store" class="tab-view">
                <h2 style="border-bottom: 2px solid var(--primary); padding-bottom:10px;">TH√îNG TIN KHO D·ª§NG C·ª§</h2>
                <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:20px;">
                    <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:5px;">
                        <h3>üîí KH√ìA AN TO√ÄN</h3>
                        <p>S·ªë l∆∞·ª£ng: 05 c√°i</p>
                        <p>V·ªã tr√≠: K·ªá A1</p>
                    </div>
                    <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:5px;">
                        <h3>üè∑Ô∏è TH·∫∫ C·∫¢NH B√ÅO</h3>
                        <p>S·ªë l∆∞·ª£ng: 50 c√°i</p>
                        <p>V·ªã tr√≠: NgƒÉn k√©o B2</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        firebase.initializeApp(firebaseConfig);

        let role = 'student';
        let state = { cb2: true, locked: false, tagged: false, running: true };

        // AUTH
        function authLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider)
                .then(res => setRole(res.user))
                .catch(err => {
                    if(location.protocol === 'file:') setRole({email: prompt("Test email:", "deptc.gvatvsld@gmail.com")});
                });
        }

        function setRole(user) {
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('user-display').innerText = user.email;
            
            if(user.email === 'deptc.gvatvsld@gmail.com') {
                role = 'instructor';
                document.getElementById('instructor-screen').classList.add('active');
            } else {
                role = 'student';
                document.getElementById('student-screen').classList.add('active');
            }
        }

        function toggleView() {
            if(role !== 'instructor') return;
            const inst = document.getElementById('instructor-screen');
            const stu = document.getElementById('student-screen');
            if(inst.classList.contains('active')) {
                inst.classList.remove('active'); stu.classList.add('active');
            } else {
                stu.classList.remove('active'); inst.classList.add('active');
            }
        }

        // NAVIGATION LOGIC
        function switchTab(tabId) {
            // Update Tab
            document.querySelectorAll('.tab-view').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            // Update Sidebar Active State
            document.querySelectorAll('.sb-item').forEach(b => b.classList.remove('active'));
            // Find nav button with ID 'nav-X' where X matches tabId suffix
            const navId = 'nav-' + tabId.replace('tab-', '');
            const btn = document.getElementById(navId);
            if(btn) btn.classList.add('active');
            
            log(`Chuy·ªÉn m√†n h√¨nh: ${tabId}`);
        }

        // INSTRUCTOR FORCE
        function forceTab(tabId) {
            switchTab(tabId);
            notify("Gi·∫£ng vi√™n y√™u c·∫ßu chuy·ªÉn m√†n h√¨nh.");
        }

        // SIMULATION LOGIC
        function machineControl(on) {
            if(on && state.cb2) {
                state.running = true;
                document.getElementById('fan-blades').style.animation = 'spin 0.2s linear infinite';
                document.getElementById('status-text').innerText = 'ƒêANG CH·∫†Y';
                document.getElementById('status-text').style.color = '#4cd137';
            } else {
                state.running = false;
                document.getElementById('fan-blades').style.animation = 'none';
                document.getElementById('status-text').innerText = 'ƒê√É D·ª™NG';
                document.getElementById('status-text').style.color = '#bdc3c7';
            }
        }

        function toggleSwitch(id, el) {
            if(id === 2 && state.locked) {
                notify("‚õî ƒê√£ kh√≥a LOTO! Kh√¥ng th·ªÉ thao t√°c."); return;
            }
            
            if(el.classList.contains('off')) {
                el.classList.remove('off'); el.innerText = "ON";
                if(id === 2) { state.cb2 = true; machineControl(true); }
            } else {
                el.classList.add('off'); el.innerText = "OFF";
                if(id === 2) { state.cb2 = false; machineControl(false); }
            }
        }

        // DRAG DROP
        function drag(ev) { ev.dataTransfer.setData("tool", ev.target.id); }
        function allowDrop(ev) { ev.preventDefault(); }
        
        function drop(ev, zoneId) {
            ev.preventDefault();
            const tool = ev.dataTransfer.getData("tool");
            const zone = document.getElementById(`zone-${zoneId}`);
            
            if(tool === 'tool-lock') {
                if(zoneId === 2) {
                    if(state.cb2) { notify("‚ö° NGUY HI·ªÇM! C·∫Øt ƒëi·ªán tr∆∞·ªõc khi kh√≥a."); return; }
                    if(state.locked) return;
                    state.locked = true;
                    zone.innerHTML += `<div class="visual-lock">üîí</div>`;
                    notify("‚úÖ ƒê√£ kh√≥a an to√†n.");
                    log("H·ªçc vi√™n ƒë√£ kh√≥a CB-02");
                } else {
                    notify("‚ö†Ô∏è Sai v·ªã tr√≠! Ki·ªÉm tra s∆° ƒë·ªì.");
                }
            }
            else if(tool === 'tool-tag') {
                if(zoneId === 2 && state.locked && !state.tagged) {
                    state.tagged = true;
                    zone.innerHTML += `<div class="visual-tag">üè∑Ô∏è</div>`;
                    notify("‚úÖ ƒê√£ treo th·∫ª.");
                } else if (!state.locked) {
                    notify("‚ö†Ô∏è Ph·∫£i kh√≥a tr∆∞·ªõc khi treo th·∫ª.");
                }
            }
            else if(tool === 'tool-meter') {
                notify("‚è≥ ƒêang ƒëo ƒëi·ªán √°p...");
                setTimeout(() => {
                    const voltage = (zoneId === 2 && state.cb2) ? "380V" : "0V";
                    notify(`K·∫øt qu·∫£ ƒëo: ${voltage}`);
                }, 1000);
            }
        }

        function actionNotify() {
            notify("üì¢ ƒê√£ ph√°t loa th√¥ng b√°o to√†n x∆∞·ªüng.");
            log("H·ªçc vi√™n ph√°t th√¥ng b√°o.");
        }

        // UTILS
        function notify(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('active');
            setTimeout(() => t.classList.remove('active'), 3000);
        }

        function log(msg) {
            const box = document.getElementById('inst-logs');
            if(box) box.innerHTML += `<div>> ${msg}</div>`;
        }

    </script>
</body>
</html>
