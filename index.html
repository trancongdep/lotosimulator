<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTO Sim v1.6</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-dark: #2f3640;
            --sidebar-width: 260px;
            --primary: #00a8ff;
            --secondary: #9c88ff;
            --danger: #e84118;
            --success: #4cd137;
            --text-color: #f5f6fa;
            --header-height: 50px;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-color);
            overflow: hidden;
        }

        /* --- HEADER --- */
        .header {
            height: var(--header-height); background: #1e272e;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid #444;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* HAMBURGER BUTTON (N√öT 3 G·∫†CH) */
        .hamburger-btn {
            background: transparent; border: 1px solid #555; color: white;
            font-size: 1.5rem; cursor: pointer; padding: 5px 10px; border-radius: 4px;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
        }
        .hamburger-btn:hover { background: rgba(255,255,255,0.1); border-color: white; }

        .app-branding { display: flex; align-items: center; }
        .app-title { font-weight: bold; letter-spacing: 1px; color: var(--primary); font-size: 1.1rem; margin-right: 10px;}
        .version-badge { font-size: 0.75rem; background: #444; color: white; padding: 2px 5px; border-radius: 3px; }
        .user-display { font-size: 0.9rem; color: #dcdde1; font-style: italic; }

        /* --- SIDEBAR (SLIDE OUT) --- */
        .sidebar {
            position: fixed; left: 0; top: var(--header-height); bottom: 0;
            width: var(--sidebar-width);
            background: #2f3640;
            border-right: 1px solid #444;
            display: flex; flex-direction: column;
            /* ·∫®n sidebar sang b√™n tr√°i */
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000; overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }
        
        /* Class ƒë·ªÉ hi·ªán sidebar */
        .sidebar.open { transform: translateX(0); }

        .sb-header {
            padding: 15px 20px 5px; font-size: 0.8rem; color: #718093; 
            text-transform: uppercase; font-weight: bold; margin-top: 10px; border-bottom: 1px solid #444;
        }

        /* Menu Items */
        .menu-item {
            display: flex; align-items: center;
            padding: 15px 20px; width: 100%;
            background: transparent; border: none; border-bottom: 1px solid #353b48;
            color: #dcdde1; cursor: pointer; text-align: left;
            transition: 0.2s; font-size: 1rem;
        }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: white; padding-left: 25px; }
        .menu-item.active { background: rgba(0, 168, 255, 0.1); border-left: 4px solid var(--primary); color: var(--primary); }

        .menu-icon { margin-right: 15px; font-size: 1.2rem; min-width: 30px; text-align: center; }

        /* Draggable Tools */
        .tool-item { cursor: grab; }
        .tool-item:active { cursor: grabbing; }
        .tool-item .menu-icon { color: var(--secondary); } 

        /* --- MAIN CONTENT AREA --- */
        .content-area {
            margin-top: var(--header-height); 
            height: calc(100vh - var(--header-height));
            width: 100%;
            box-sizing: border-box;
            background: radial-gradient(circle at center, #353b48 0%, #2f3640 100%);
            position: relative;
        }

        /* Overlay khi m·ªü menu (ƒë·ªÉ b·∫•m ra ngo√†i th√¨ ƒë√≥ng) */
        .overlay-backdrop {
            position: fixed; top: var(--header-height); left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 900; display: none;
        }
        .overlay-backdrop.show { display: block; }

        /* Screens */
        .screen { display: none; height: 100%; width: 100%; }
        .screen.active { display: block; }
        
        /* Views (Tabs) inside Student Screen */
        .view-tab {
            display: none; height: 100%; padding: 20px; box-sizing: border-box;
            flex-direction: column; align-items: center; justify-content: flex-start;
            animation: fadeIn 0.3s; overflow-y: auto;
        }
        .view-tab.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- VISUAL COMPONENTS --- */
        .panel { background: #353b48; padding: 20px; border-radius: 8px; border: 1px solid #555; width: 100%; max-width: 800px; margin-bottom: 20px;}
        
        /* Fan */
        .fan-frame {
            width: 220px; height: 220px; border: 8px solid #7f8c8d; border-radius: 50%;
            background: #222; display: flex; align-items: center; justify-content: center; margin: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .fan-blade { width: 200px; height: 25px; background: linear-gradient(to right, #bdc3c7, #7f8c8d); position: absolute; border-radius: 12px; }
        .spin { animation: spin 0.2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Electrical Panel */
        .elec-row { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-top: 20px;}
        .cb-unit {
            width: 100px; height: 180px; background: #2f3640; border-radius: 6px; position: relative;
            display: flex; flex-direction: column; align-items: center; border: 2px solid #555;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.3);
        }
        .cb-handle {
            width: 70px; height: 60px; background: var(--danger); margin-top: 40px; cursor: pointer;
            border-radius: 4px; z-index: 10; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; transition: 0.3s; border: 1px solid rgba(0,0,0,0.2);
        }
        .cb-handle::after { content: "ON"; }
        .cb-handle.off { transform: translateY(50px); background: var(--success); }
        .cb-handle.off::after { content: "OFF"; }
        
        .drop-zone { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 5; }

        /* Dropped Items */
        .v-lock { position: absolute; top: 30px; left: 25px; font-size: 3rem; pointer-events: none; z-index: 20; filter: drop-shadow(3px 3px 3px black); }
        .v-tag { position: absolute; top: 60px; left: 30px; font-size: 2.5rem; pointer-events: none; z-index: 21; filter: drop-shadow(3px 3px 3px black); transform: rotate(-10deg); }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 100px);
            background: #333; color: white; padding: 12px 30px; border-radius: 30px; 
            border: 2px solid var(--primary); font-weight: bold;
            transition: 0.3s; z-index: 3000; opacity: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .toast.show { transform: translate(-50%, 0); opacity: 1; }

    </style>
</head>
<body>

    <div class="header">
        <div class="app-branding">
            <button class="hamburger-btn" onclick="toggleSidebar()">
                ‚ò∞
            </button>
            <div class="app-title">LOTO Sim <span class="version-badge">v1.6</span></div>
        </div>
        <div class="user-display" id="header-user">Kh√°ch</div>
    </div>

    <div class="overlay-backdrop" id="backdrop" onclick="toggleSidebar()"></div>

    <div id="toast" class="toast">H·ªá th·ªëng s·∫µn s√†ng</div>

    <div id="login-screen" class="screen active" style="display: flex; align-items: center; justify-content: center; background: #222;">
        <div style="text-align: center; background: white; padding: 40px; border-radius: 10px; color: #333; max-width: 400px;">
            <h1 style="margin-top:0; color: var(--primary);">ƒêƒÇNG NH·∫¨P</h1>
            <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ h·ªá th·ªëng x√°c ƒë·ªãnh vai tr√≤.</p>
            <button onclick="doLogin()" style="padding:12px 30px; background: #e74c3c; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);">
                ƒêƒÉng nh·∫≠p Google
            </button>
            <div style="margin-top:20px; font-size: 0.8rem; color: #888; border-top: 1px solid #eee; padding-top: 10px;">
                Gi·∫£ng vi√™n test: deptc.gvatvsld@gmail.com
            </div>
        </div>
    </div>

    <div id="instructor-screen" class="screen">
        <div class="content-area" style="padding: 20px;">
            <div class="panel">
                <h2 style="color:var(--primary); margin-top:0; border-bottom: 2px solid #555; padding-bottom: 10px;">B·∫¢NG GI·∫¢NG VI√äN</h2>
                <div style="display:grid; gap: 10px;">
                    <button class="menu-item" style="border:1px solid #555; background: #444;" onclick="forceStudent('view-device')">‚û°Ô∏è Chuy·ªÉn HS ƒë·∫øn: M√°y M√≥c</button>
                    <button class="menu-item" style="border:1px solid #555; background: #444;" onclick="forceStudent('view-electrical')">‚û°Ô∏è Chuy·ªÉn HS ƒë·∫øn: T·ªß ƒêi·ªán</button>
                    <button class="menu-item" style="border:1px solid #555; background: #444;" onclick="forceStudent('view-diagram')">‚û°Ô∏è Chuy·ªÉn HS ƒë·∫øn: S∆° ƒê·ªì</button>
                    <button class="menu-item" style="border:1px solid #555; background: #444;" onclick="forceStudent('view-store')">‚û°Ô∏è Chuy·ªÉn HS ƒë·∫øn: Kho</button>
                </div>
                <hr style="border-color:#555; margin: 20px 0;">
                <button onclick="resetApp()" style="width:100%; padding:15px; background:var(--danger); border:none; color:white; cursor:pointer; font-weight:bold; border-radius: 5px;">RESET TO√ÄN B·ªò</button>
            </div>
            
            <div class="panel" style="max-height: 300px; overflow-y: auto;">
                <h3 style="margin-top:0; color: var(--success);">NH·∫¨T K√ù L·ªöP H·ªåC</h3>
                <div id="inst-log" style="font-family: monospace; color: #00d2d3;">
                    > H·ªá th·ªëng kh·ªüi t·∫°o th√†nh c√¥ng.<br>
                </div>
            </div>
        </div>
    </div>

    <div id="student-screen" class="screen">
        
        <div class="sidebar" id="main-sidebar">
            <div class="sb-header">KHU V·ª∞C L√ÄM VI·ªÜC</div>
            
            <button class="menu-item active" onclick="navTo('view-device')" id="btn-view-device">
                <span class="menu-icon">üè≠</span> Khu v·ª±c M√°y (Device)
            </button>

            <button class="menu-item" onclick="navTo('view-electrical')" id="btn-view-electrical">
                <span class="menu-icon">‚ö°</span> T·ªß ƒêi·ªán (Panel)
            </button>

            <button class="menu-item" onclick="navTo('view-diagram')" id="btn-view-diagram">
                <span class="menu-icon">üó∫Ô∏è</span> S∆° ƒê·ªì (Diagram)
            </button>

            <button class="menu-item" onclick="navTo('view-store')" id="btn-view-store">
                <span class="menu-icon">üì¶</span> Kho (Inventory)
            </button>

            <div class="sb-header">D·ª§NG C·ª§ (K√âO TH·∫¢ RA NGO√ÄI)</div>
            
            <div class="menu-item tool-item" draggable="true" ondragstart="drag(event)" id="tool-lock">
                <span class="menu-icon">üîí</span> ·ªî Kh√≥a An To√†n
            </div>

            <div class="menu-item tool-item" draggable="true" ondragstart="drag(event)" id="tool-tag">
                <span class="menu-icon">üè∑Ô∏è</span> Th·∫ª C·∫£nh B√°o
            </div>

            <div class="menu-item tool-item" draggable="true" ondragstart="drag(event)" id="tool-meter">
                <span class="menu-icon">‚ö°</span> ƒê·ªìng H·ªì VOM
            </div>

             <div class="menu-item tool-item" onclick="actionSpeaker()">
                <span class="menu-icon">üì¢</span> Loa Th√¥ng B√°o
            </div>
        </div>

        <div class="content-area">
            
            <div id="view-device" class="view-tab active">
                <div class="panel" style="text-align: center;">
                    <h2 style="color: var(--primary);">QU·∫†T C√îNG NGHI·ªÜP S·ªê 02</h2>
                    <div class="fan-frame">
                        <div class="fan-blade spin" id="fan"></div>
                        <div class="fan-blade spin" style="transform: rotate(120deg);"></div>
                        <div class="fan-blade spin" style="transform: rotate(240deg);"></div>
                    </div>
                    <div id="st-machine" style="font-size: 1.5rem; font-weight: bold; color: var(--success); margin: 20px 0;">ƒêANG CH·∫†Y</div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="setMachine(true)" style="padding: 10px 30px; background: var(--success); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px;">START</button>
                        <button onclick="setMachine(false)" style="padding: 10px 30px; background: var(--danger); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px;">STOP</button>
                    </div>
                </div>
            </div>

            <div id="view-electrical" class="view-tab">
                <div class="panel">
                    <h2 style="color: var(--primary); text-align: center;">T·ª¶ PH√ÇN PH·ªêI DB-01</h2>
                    <p style="text-align: center; color: #aaa;">K√©o kh√≥a/th·∫ª t·ª´ Menu (3 g·∫°ch) th·∫£ v√†o Aptomat</p>
                    
                    <div class="elec-row">
                        <div class="cb-unit">
                            <span style="font-size:0.8rem; margin-top:10px; color:#aaa">CB-1 (Light)</span>
                            <div class="cb-handle" onclick="toggleCB(1, this)"></div>
                            <div class="drop-zone" id="dz-1" ondragover="allow(event)" ondrop="drop(event, 1)"></div>
                        </div>
                        <div class="cb-unit" style="border-color: var(--primary);">
                            <span style="font-size:0.8rem; margin-top:10px; color:var(--primary); font-weight:bold;">CB-2 (FAN)</span>
                            <div class="cb-handle" id="lev-2" onclick="toggleCB(2, this)"></div>
                            <div class="drop-zone" id="dz-2" ondragover="allow(event)" ondrop="drop(event, 2)"></div>
                        </div>
                        <div class="cb-unit">
                            <span style="font-size:0.8rem; margin-top:10px; color:#aaa">CB-3 (Socket)</span>
                            <div class="cb-handle" onclick="toggleCB(3, this)"></div>
                            <div class="drop-zone" id="dz-3" ondragover="allow(event)" ondrop="drop(event, 3)"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-diagram" class="view-tab">
                <div class="panel" style="background: white; color: #333;">
                    <h2 style="color: #333; text-align: center;">S∆† ƒê·ªí ƒê∆†N TUY·∫æN</h2>
                    <svg width="100%" height="250" viewBox="0 0 500 250">
                        <text x="20" y="30" font-weight="bold">380V Main</text>
                        <line x1="40" y1="40" x2="40" y2="220" stroke="red" stroke-width="6"/>
                        
                        <line x1="40" y1="120" x2="180" y2="120" stroke="black" stroke-width="3"/>
                        <rect x="180" y="100" width="60" height="40" fill="none" stroke="blue" stroke-width="3"/>
                        <text x="190" y="125" font-size="14" fill="blue" font-weight="bold">CB-2</text>
                        
                        <line x1="240" y1="120" x2="380" y2="120" stroke="black" stroke-width="3"/>
                        <circle cx="410" cy="120" r="25" fill="#333"/>
                        <text x="385" y="170" font-size="14" font-weight="bold">MOTOR FAN</text>
                    </svg>
                    <p style="text-align: center;"><strong>X√°c nh·∫≠n:</strong> CB-2 c·∫•p ngu·ªìn cho Motor Qu·∫°t.</p>
                </div>
            </div>

            <div id="view-store" class="view-tab">
                <div class="panel">
                    <h2 style="color: var(--primary);">KHO V·∫¨T T∆Ø</h2>
                    <ul style="list-style: none; padding: 0; font-size: 1.2rem;">
                        <li style="padding: 10px; border-bottom: 1px solid #555;">üîí ·ªî kh√≥a an to√†n: <strong>S·∫µn s√†ng</strong></li>
                        <li style="padding: 10px; border-bottom: 1px solid #555;">üè∑Ô∏è Th·∫ª c·∫£nh b√°o: <strong>S·∫µn s√†ng</strong></li>
                        <li style="padding: 10px; border-bottom: 1px solid #555;">‚ö° ƒê·ªìng h·ªì ƒëo ƒëi·ªán: <strong>ƒê√£ ki·ªÉm ƒë·ªãnh</strong></li>
                        <li style="padding: 10px;">üß§ ƒê·ªì b·∫£o h·ªô PPE: <strong>ƒê·ªß size</strong></li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

    <script>
        // INIT FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        firebase.initializeApp(firebaseConfig);
        
        let role = 'guest';
        let sys = { cb2: true, locked: false, tagged: false, running: true };

        // SIDEBAR TOGGLE LOGIC
        function toggleSidebar() {
            const sb = document.getElementById('main-sidebar');
            const bd = document.getElementById('backdrop');
            sb.classList.toggle('open');
            bd.classList.toggle('show');
        }

        // LOGIN LOGIC
        function doLogin() {
            const p = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(p).then(r => setRole(r.user)).catch(e => {
                // Fallback test
                if(location.protocol==='file:') setRole({email: prompt("Test Email:", "deptc.gvatvsld@gmail.com")});
            });
        }
        function setRole(u) {
            document.getElementById('login-screen').classList.remove('active');
            const shortName = u.email.split('@')[0];
            document.getElementById('header-user').innerText = shortName;

            if(u.email === 'deptc.gvatvsld@gmail.com') {
                role = 'instructor';
                document.getElementById('instructor-screen').classList.add('active');
            } else {
                role = 'student';
                document.getElementById('student-screen').classList.add('active');
                msg("Ch√†o m·ª´ng " + shortName);
            }
        }

        // NAVIGATION LOGIC
        function navTo(viewId) {
            // 1. ·∫®n t·∫•t c·∫£ view
            document.querySelectorAll('.view-tab').forEach(el => el.classList.remove('active'));
            // 2. Hi·ªán view m·ª•c ti√™u
            document.getElementById(viewId).classList.add('active');
            
            // 3. Update tr·∫°ng th√°i active trong menu
            document.querySelectorAll('.menu-item').forEach(b => b.classList.remove('active'));
            const btnId = 'btn-' + viewId;
            if(document.getElementById(btnId)) document.getElementById(btnId).classList.add('active');
            
            // 4. QUAN TR·ªåNG: ƒê√≥ng sidebar ngay l·∫≠p t·ª©c ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y thay ƒë·ªïi
            const sb = document.getElementById('main-sidebar');
            if(sb.classList.contains('open')) toggleSidebar();

            msg(`ƒê√£ chuy·ªÉn ƒë·∫øn: ${viewId.replace('view-','').toUpperCase()}`);
        }

        function forceStudent(viewId) {
            // Logic gi·∫£ l·∫≠p realtime: Instructor b·∫•m -> Student chuy·ªÉn view
            // Trong th·ª±c t·∫ø c·∫ßn Firebase Realtime Database. ·ªû ƒë√¢y ta gi·∫£ l·∫≠p ch·∫°y tr√™n m√°y instructor
            navTo(viewId); 
            msg("Gi·∫£ng vi√™n ƒë√£ ƒë·ªïi m√†n h√¨nh.");
        }

        // SIMULATION LOGIC
        function setMachine(run) {
            if(run && sys.cb2) {
                sys.running = true;
                document.querySelectorAll('.fan-blade').forEach(b => b.style.animation = 'spin 0.2s linear infinite');
                document.getElementById('st-machine').innerText = 'ƒêANG CH·∫†Y';
                document.getElementById('st-machine').style.color = 'var(--success)';
            } else {
                sys.running = false;
                document.querySelectorAll('.fan-blade').forEach(b => b.style.animation = 'none');
                document.getElementById('st-machine').innerText = 'ƒê√É D·ª™NG';
                document.getElementById('st-machine').style.color = '#bdc3c7';
            }
        }

        function toggleCB(id, el) {
            if(id === 2 && sys.locked) { msg("‚õî ƒê√£ kh√≥a LOTO! Kh√¥ng th·ªÉ thao t√°c."); return; }
            
            if(el.classList.contains('off')) {
                el.classList.remove('off'); 
                if(id === 2) { sys.cb2 = true; setMachine(true); }
            } else {
                el.classList.add('off'); 
                if(id === 2) { sys.cb2 = false; setMachine(false); }
            }
        }

        // DRAG DROP
        function drag(e) { e.dataTransfer.setData("t", e.target.id); }
        function allow(e) { e.preventDefault(); }
        function drop(e, id) {
            e.preventDefault();
            const t = e.dataTransfer.getData("t");
            const z = document.getElementById('dz-'+id);
            
            if(t==='tool-lock') {
                if(id!==2) { msg("‚ö†Ô∏è Sai CB!"); return; }
                if(sys.cb2) { msg("‚ö° C√≤n ƒëi·ªán! C·∫Øt CB tr∆∞·ªõc."); return; }
                if(!sys.locked) {
                    sys.locked = true;
                    z.innerHTML += `<div class="v-lock">üîí</div>`;
                    msg("‚úÖ ƒê√£ kh√≥a an to√†n.");
                    log("User locked CB2");
                }
            } else if(t==='tool-tag') {
                if(id===2 && sys.locked && !sys.tagged) {
                    sys.tagged = true;
                    z.innerHTML += `<div class="v-tag">üè∑Ô∏è</div>`;
                    msg("‚úÖ ƒê√£ treo th·∫ª.");
                } else if (!sys.locked) msg("‚ö†Ô∏è Ph·∫£i kh√≥a tr∆∞·ªõc!");
            } else if(t==='tool-meter') {
                msg("‚è≥ ƒêang ƒëo...");
                setTimeout(() => msg((id===2 && sys.cb2) ? "‚ö° 380V (NGUY HI·ªÇM)" : "‚úÖ 0V (AN TO√ÄN)"), 1000);
            }
        }

        function actionSpeaker() { 
            msg("üì¢ ƒê√£ ph√°t loa th√¥ng b√°o to√†n x∆∞·ªüng."); 
            log("User announced via speaker."); 
            // ƒê√≥ng sidebar n·∫øu ƒëang d√πng speaker t·ª´ menu
            const sb = document.getElementById('main-sidebar');
            if(sb.classList.contains('open')) toggleSidebar();
        }

        // UTILS
        function msg(txt) {
            const t = document.getElementById('toast');
            t.innerText = txt; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2000);
        }
        function log(txt) {
            const l = document.getElementById('inst-log');
            if(l) l.innerHTML += `<div>> ${txt}</div>`;
        }
        function resetApp() { location.reload(); }

    </script>
</body>
</html>
